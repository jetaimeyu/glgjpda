webpackJsonp([21],{"/TM1":function(t,e){},"0NzE":function(t,e){},DxaA:function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var s=n("Gu7T"),a=n.n(s),r=n("Xxa5"),o=n.n(r),i=n("exGp"),u=n.n(i),c=n("woOf"),l=n.n(c),f=n("Dd8w"),v=n.n(f),d=n("NYxO"),h=n("ABCa"),b=n("odqc"),m=n("Znkm"),k=n("2sLL"),p=n("62KO"),x=n("rHil"),C=n("1DHf"),O=n("UNGY"),w=n("ALGc"),D=n("7Ah8"),I=n("BPFO"),j=n("5XJp"),S=n("M/Ia"),y=n("oqQY"),g=n.n(y),T=(Number,Object,x.a,C.a,O.a,w.a,D.a,I.a,S.a,{data:function(){return{formObj:{Executors:[],Senders:[],TaskType:1,CustomerID:0,LinkUserID:0,BeginDate:g()().format("YYYY-MM-DD HH:mm"),TaskContent:"",TaskPriority:1},prity:[["低","中","高"]],exeShow:!1,senShow:!1,exeList:[],senList:[],taskPriority:["低"],CurRule:!0,defCurObj:{CustomerID:0,CustomerName:"",LinkUserID:0},ids:[],id2:[]}},props:{ovoIndex:{type:Number},curObj:{type:Object}},watch:{ovoIndex:function(t){this.formObj.TaskType=t+1,this.CurRule=0===t}},components:{Group:x.a,Cell:C.a,Datetime:O.a,XTextarea:w.a,PopupPicker:D.a,UserSelect:I.a,ClientLink:S.a},computed:{exeStr:function(){return this.exeList.map(function(t){return t.OrgName}).join(",")},senStr:function(){return this.senList.map(function(t){return t.OrgName}).join(",")}},methods:{toSelectCur:function(){this.$router.push({path:"/selectCust"})},toSelectExecutor:function(){this.exeShow=!0},toSelectSender:function(){this.senShow=!0},saveExe:function(t){if(t.length){this.exeList=t,this.ids=t.map(function(t){return{UserID:t.ID,Name:t.OrgName}}),this.exeShow=!1;var e=t.map(function(t){return{IsDelete:0,ID:0,UserID:t.ID}});this.formObj.Executors=e}else this.$vux.toast.show({type:"warn",text:"请选择执行人"})},saveSen:function(t){if(t.length){this.senList=t,this.senShow=!1,this.id2=t.map(function(t){return{UserID:t.ID,Name:t.OrgName}});var e=t.map(function(t){return{IsDelete:0,ID:0,UserID:t.ID}});this.formObj.Senders=e}else this.$vux.toast.show({type:"warn",text:"请选择抄送人"})},init:function(){this.exeList=[],this.senList=[],this.curObj.cId&&(this.defCurObj.CustomerID=this.curObj.cId,this.defCurObj.CustomerName=this.curObj.cName,this.defCurObj.LinkUserID=this.curObj.cLink)},priChange:function(){this.formObj.TaskPriority=j.a.unProority(this.taskPriority[0])}},mounted:function(){this.init()}}),_={render:function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"task-form"},[n("Group",[n("ClientLink",{ref:"client",attrs:{isSelect:!t.curObj.cId,workRu:t.CurRule,path:"/AddTask/selectCust",data:t.defCurObj}}),t._v(" "),n("datetime",{attrs:{format:"YYYY-MM-DD HH:mm"},model:{value:t.formObj.BeginDate,callback:function(e){t.$set(t.formObj,"BeginDate",e)},expression:"formObj.BeginDate"}},[n("div",{staticClass:"label",attrs:{slot:"title"},slot:"title"},[n("span",{staticClass:"form-label"},[t._v("*")]),t._v("执行时间\n      ")])]),t._v(" "),n("x-textarea",{attrs:{max:300,placeholder:"请输入任务内容...","show-counter":!1},model:{value:t.formObj.TaskContent,callback:function(e){t.$set(t.formObj,"TaskContent","string"==typeof e?e.trim():e)},expression:"formObj.TaskContent"}},[n("div",{staticClass:"label",attrs:{slot:"label"},slot:"label"},[n("span",{staticClass:"form-label"},[t._v("*")])])]),t._v(" "),n("cell",{attrs:{"is-link":"",value:t.exeStr},nativeOn:{click:function(e){return t.toSelectExecutor(e)}}},[n("div",{attrs:{slot:"title"},slot:"title"},[n("span",[t._v("执行人(留空表示自己)")])])]),t._v(" "),n("cell",{attrs:{title:"抄送人","is-link":"",value:t.senStr},nativeOn:{click:function(e){return t.toSelectSender(e)}}}),t._v(" "),n("popup-picker",{attrs:{data:t.prity},on:{"on-change":t.priChange},model:{value:t.taskPriority,callback:function(e){t.taskPriority=e},expression:"taskPriority"}},[n("div",{staticClass:"label",attrs:{slot:"title"},slot:"title"},[n("span",{staticClass:"form-label"},[t._v("*")]),t._v("优先级\n      ")])])],1),t._v(" "),n("UserSelect",{ref:"userExe",attrs:{title:"选择执行人",show:t.exeShow,defaultUser:t.ids},on:{close:function(e){t.exeShow=!1},save:t.saveExe}}),t._v(" "),n("UserSelect",{ref:"userSen",attrs:{title:"选择抄送人",show:t.senShow,defaultUser:t.id2},on:{close:function(e){t.senShow=!1},save:t.saveSen}}),t._v(" "),n("div",[n("router-view",{staticClass:"selectCust"})],1)],1)},staticRenderFns:[]};var L=n("VU/8")(T,_,!1,function(t){n("0NzE")},"data-v-2204943a",null).exports,U=(h.a,b.a,m.a,k.a,p.a,v()({},Object(d.e)(["CurrentUserID"])),{data:function(){return{tabTxt:["客户跟进任务","普通任务"],ovoIndex:0,saveObj:{},workID:null,createUser:null,addShow:!1}},components:{XHeader:h.a,Tab:b.a,TabItem:m.a,AddForm:L,XButton:k.a,Confirm:p.a},computed:v()({},Object(d.e)(["CurrentUserID"])),methods:{tabLeft:function(){this.addShow=!0},addDialog:function(){this.$router.back()},tabRight:function(){var t=this.$refs.taskForm.$refs.client.getData();this.saveObj=l()({},this.$refs.taskForm.formObj),this.saveObj.CustomerID=t.CustomerID,this.saveObj.LinkUserID=t.LinkUserID,this.saveObj.BeginDate+=":00",this.formRules()},selectTaskType:function(t){console.log(t),this.ovoIndex=t},formRules:function(){var t=this;return u()(o.a.mark(function e(){var n,s;return o.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(0!==t.ovoIndex){e.next=4;break}if(t.saveObj.CustomerID&&t.saveObj.LinkUserID){e.next=4;break}return t.$vux.toast.show({type:"warn",text:"请选择客户跟联系人"}),e.abrupt("return",!1);case 4:if(n=(n=(n=t.saveObj.BeginDate).substring(0,19)).replace(/-/g,"/"),s=new Date(n).getTime(),":00"!==t.saveObj.BeginDate){e.next=13;break}return t.$vux.toast.show({type:"warn",text:"请选择执行时间"}),e.abrupt("return",!1);case 13:if(!(new Date>s)){e.next=16;break}return t.$vux.toast.show({type:"warn",text:"执行时间不能小于当前时间"}),e.abrupt("return",!1);case 16:if(t.saveObj.TaskContent){e.next=21;break}return t.$vux.toast.show({type:"warn",text:"请输入任务内容"}),e.abrupt("return",!1);case 21:if(!(t.saveObj.TaskContent.length<5)){e.next=24;break}return t.$vux.toast.show({type:"warn",text:"任务内容应在5-200之间"}),e.abrupt("return",!1);case 24:if(t.saveObj.TaskPriority){e.next=27;break}return t.$vux.toast.show({type:"warn",text:"请选择任务优先级"}),e.abrupt("return",!1);case 27:return e.next=29,t.saveWork(t.saveObj);case 29:return e.sent,e.next=32,t.getWorkInfo(t.workID);case 32:e.sent,t.newMessage(),t.$router.back();case 35:case"end":return e.stop()}},e,t)}))()},saveWork:function(t){var e=this;return this.Axios.post("/CrmTask/SaveCrmTask",t).then(function(t){e.$vux.toast.show({text:"保存成功"}),e.workID=t.data.Data,e.$bus.emit("onSave",!0)})},newMessage:function(){var t=this,e=[].concat(a()(this.saveObj.Executors),a()(this.saveObj.Senders)).map(function(t){return t.UserID});e.forEach(function(n,s){n===t.CurrentUserID&&e.splice(s,1)}),this.send(e,this.workID)},send:function(t,e){var n={SendUsers:t,EvName:"crm-task",ImgPath:down+"/mdtcrm/CRMTask.jpg",Title:"您有一条新的待办任务",Content:""+this.saveObj.TaskContent,Params:[e]};this.Axios.post(api50+"/api/v1/Common/SendSingleEventMsg",n).then(function(t){}).catch(function(t){console.log(t,90)})},getWorkInfo:function(t){var e=this;return this.Axios.get("/CrmTask/GetCrmTaskInfoByID/"+t).then(function(t){e.createUser=t.data.Data.CreateUserName})}},beforeRouteLeave:function(t,e,n){var s=this;"/TaskWork"===t.fullPath&&(t.meta.keepAlive=!0);try{plus.key.removeEventListener("backbutton",function(){}),plus.key.addEventListener("backbutton",function(){s.$router.back()})}catch(t){}n(function(t){})},mounted:function(){var t=this;try{plus.key.removeEventListener("backbutton",function(){}),plus.key.addEventListener("backbutton",function(){t.addShow=!0})}catch(t){}}}),$={render:function(){var t=this,e=t.$createElement,n=t._self._c||e;return n("div",{staticClass:"add-task"},[n("div",{staticClass:"header"},[n("x-header",{attrs:{"left-options":{backText:"",preventGoBack:!0}},on:{"on-click-back":t.tabLeft}},[t._v("新建待办任务\n      ")])],1),t._v(" "),t.$route.query.cId?t._e():n("div",{staticClass:"abs-ddd"},[n("tab",t._l(t.tabTxt,function(e,s){return n("tab-item",{key:s,attrs:{selected:0===s},on:{"on-item-click":function(e){t.selectTaskType(s)}}},[t._v(t._s(e))])}))],1),t._v(" "),n("AddForm",{ref:"taskForm",attrs:{ovoIndex:t.ovoIndex,curObj:t.$route.query}}),t._v(" "),n("div",{staticStyle:{position:"fixed",bottom:"0",width:"100%"}},[n("x-button",{attrs:{type:"primary"},nativeOn:{click:function(e){return t.tabRight(e)}}},[t._v("保存")])],1),t._v(" "),n("Confirm",{attrs:{title:"继续退出？",content:"您已编辑过，退出将丢失这些内容！"},on:{"on-cancel":function(e){t.addShow=!1},"on-confirm":t.addDialog},model:{value:t.addShow,callback:function(e){t.addShow=e},expression:"addShow"}})],1)},staticRenderFns:[]};var E=n("VU/8")(U,$,!1,function(t){n("/TM1")},"data-v-480b185e",null);e.default=E.exports}});
//# sourceMappingURL=21.8d1121c85271f8fa2c9e.js.map