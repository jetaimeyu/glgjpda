<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="../../css/mui.min.css">
		<link rel="stylesheet" href="../../icon-font/iconfont.css" />
		<link rel="stylesheet" href="../../css/common.css">
		<style>
			.enable-color {
				color: #7db2f0;
			}
			
			.mui-card {
				box-shadow: none;
			}
			
			.mui-card-header {
				background-color: #F6FBFF;
			}
			
			.mui-card-header:after {
				height: 0;
			}
			
			.mui-table-view .mui-media-object {
				border: 0;
				background: none;
			}
			
			.mui-table-view .mui-media-object {
				width: 80px;
				text-align: right;
				max-width: 80px;
			}
			
			.right-boder {
				border-right: 1px solid #63B1FF;
			}
			
			.mui-card-header .pro-title {
				font-size: 16px;
				color: #333333;
				margin-left: 5px;
				font-weight: bold;
			}
			
			.mui-card-header .pro-state {
				font-size: 13px;
				flex: none;
			}
			
			.mui-card-header .state-ing {
				color: #04CDDB;
			}
			
			.mui-card-header .state-wait {
				color: #FFB76F;
			}
			
			.mui-card-header .state-done {
				color: #999999;
			}
			
			.mui-card-content .mui-media-body {
				font-size: 14px;
				color: #323232;
			}
			
			.mui-card-content .mui-media-body .codenumber {
				font-size: 13px;
				color: #333333;
			}
			
			.mui-card-content .mui-media-body .sku {
				font-size: 13px;
				color: #999999;
			}
			
			.mui-card-footer .mui-row {
				text-align: center;
				font-size: 13px;
				color: #3296FA;
			}
			
			.mui-card-content .mui-empty {
				text-align: center;
				color: #3296FA;
				font-size: 13px;
			}
			
			.show-more {
				display: flex;
				color: #ffffff;
				text-align: center;
				height: 40px;
				line-height: 40px;
				font-size: 16px;
				box-shadow: 0 -1px 5px #eee;
				position: fixed;
				bottom: 0;
				left: 0;
				width: 100%;
				box-sizing: border-box;
				background-color: #007aff;
				z-index: 4;
			}
			
			.scanline {
				display: inline-block;
				height: 20px;
				width: 1px;
				line-height: 40px;
				background: #FFFFFF;
				float: right;
				margin-top: 8px;
				opacity: 0.3116;
				box-shadow: 1px 0 0 #124477;
			}
			
			.mui-popover {
				/*min-width: 260px;*/
				/*height: 370px;*/
				position: fixed;
				top: 50%;
				/*bottom: 50%;*/
				/*position: absolute;
				top: 65%;
				margin-top: -150px;*/
				left: 50% !important;
				margin-left: -141px;
				border-radius: 3px;
				background-color: #fff;
				margin-top: -100px;
			}
			
			.mui-popover .mui-popover-arrow {
				display: none !important;
			}
			
			.mui-popover .data-group:before {
				height: 0;
			}
			
			.mui-popover .data-group .data-row:after {
				left: 10px;
				background-color: #E5E5E5;
			}
			
			.mui-popover .data-group .data-row.first:after {
				left: 5px;
				right: 5px;
				background-color: #E5E5E5;
				height: 0!important;
			}
			
			.mui-popover .data-group .data-row:last-child:after {
				height: 1px;
				left: 5px;
				right: 5px;
			}
			
			.mui-popover .data-group .data-row.first {
				min-height: 38px
			}
			
			.addelment a {
				background-color: #3296FA;
				color: #fff;
				padding: 10px 0;
				border: 1px solid #3296FA;
				border-top-left-radius: 0;
				border-top-right-radius: 0;
			}
			
			.data-group .data-row .label-gray {
				color: #333333;
			}
			
			.info-title {
				margin-left: 10px;
				line-height: 1;
				color: #1f1f1f;
			}
			
			.title {
				color: #1f1f1f;
			}
			
			.data-group .data-row label~.body {
				margin-left: 60px;
				margin-right: 25px;
			}
			
			.mui-popover {
				padding: 0;
				background: #F6FBFF;
			}
			
			.mui-popover .mui-icon-closeempty {
				float: right;
				margin-top: 5px;
				margin-right: 5px;
				height: 29px;
				width: 25px;
			}
			
			.mui-popover .data-group .data-row .body {
				padding: 8px 0 5px 10px;
			}
			
			.data-group .data-row .body input,
			.data-group .data-row .body>span,
			.data-group .data-row .body select {
				padding: 0 5px 5px 5px;
			}
			
			.mui-popover .needsclick {
				width: 100%;
			}
			
			.mui-popover .edit {
				margin: 0px 0px 0px 10px !important;
			}
			
			.mui-content>.mui-card:first-child {
				margin-top: 0px;
			}
			
			.mui-card {
				margin: 0 10px 10px;
			}
			
			.mui-card-header .mui-icon img {
				width: 18px;
				width: 15px;
			}
			
			.selProducticon {
				width: 25px;
				float: right;
				padding-top: 7px;
				height: 40px;
			}
			
			.del-button {
				background-color: #E64340 !important;
				border: 1px solid #E64340 !important;
				/*background-color: #F5F5F5 !important;
                border: 1px solid #F5F5F5 !important;
                 color: #333333 !important;*/
			}
			
			.mui-show {
				display: block;
			}
			
			.noParts {
				text-align: center;
				color: #999999;
			}
			
			.start-ass {
				font-size: 13px;
				color: #3296FA;
				text-align: center;
			}
			
			.adjust-ass {
				font-size: 13px;
				color: #93ABC3;
				text-align: center;
			}
			
			.data-group .data-row label,
			.data-group .data-row .opt,
			.data-group .data-row .body.arrow:after {
				position: absolute;
				top: 50%;
				-webkit-transform: translateY(-50%);
				transform: translateY(-50%);
				overflow: hidden;
				margin: 0;
			}
			
			.data-group .data-row {
				display: block;
			}
			
			.data-group .data-row label {
				width: 70px;
				left: 10px;
				color: #666;
			}
			
			.part-right-btn {
				width: 50%;
				display: inline-block;
				margin-bottom: 0px !important;
				border-bottom-right-radius: 0;
			}
			
			.part-left-btn {
				width: 50%;
				display: inline-block;
				border-bottom-left-radius: 0;
			}
			
			.dis-none {
				display: none;
			}
			
			.dis-block {
				display: block;
			}
			
			.mui-table-view-cell:after {
				left: 0;
			}
			/*.top-line:before {
				height: 1px !important;
			}*/
			
			.edit {
				margin-top: 10px;
				height: auto;
			}
			
			.startDataNone {
				margin: 0 15px 10px 15px;
				height: 190px;
				background: #fff;
				text-align: center;
				position: relative;
				padding-top: 60px;
				box-shadow: rgb(189, 194, 194) 0px 2px 4px 0px;
			}
			
			.startDataNone .noneConcent {
				position: absolute;
				top: 0;
				bottom: 0;
				right: 0;
				left: 0;
				margin: auto;
				height: 70px;
			}
			
			.startDataNone p {
				color: #999999;
				font-size: 15px;
			}
			
			.menu-audit {
				padding: 10px 10px;
			}
			
			.saomiao {
				width: 64px;
				position: absolute;
				left: 50%;
				height: 64px;
				bottom: 0;
				background: #FF8C22;
				border: 3px solid #fff;
				border-radius: 50%;
				text-align: center;
				margin-left: -32px;
				z-index: 99999999;
			}
			
			.icon-saomiao {
				line-height: 58px;
				font-size: 24px;
			}
			
			.menu-audit span {
				color: #3296FA;
			}
			
			.mui-popover .edit input {
				margin-right: 0px !important;
			}
			
			.mui-tip {
				line-height: 40px;
				padding: 0 10px;
			}
			
			.empty {
				margin-top: 30vh;
				width: 100%;
				text-align: center;
				word-break: break-all;
				color: #666666;
				font-size: 1.5rem;
				padding: 0 15px;
			}
			
			.data-group .data-row.mustb label:before {
				content: '*';
				color: #DC0000;
			}
		</style>
	</head>

	<body ms-controller="productCtrl" class="ms-controller">
		<!--头部-->
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon icon-back mui-icon-left-nav mui-pull-left"></a>
			<h1 class="mui-title" style="padding-left: 0!important;"><span class="mui-action-back">锁定装配</span></h1>
			<a class="mui-pull-right menu-audit changeAudit" ms-attr="{'type':isaudit}">
				<span ms-visible="isaudit==0" class="icon-shengyin"></span>
				<span ms-visible="isaudit==1" class="icon-jingyin"></span>

			</a>
		</header>
		<div id="pullrefresh" class="mui-scroll-wrapper" style="margin-bottom: 65px">
			<div class="mui-scroll">
				<div class="mui-content main-content">

					<div class="edit">
						<div class="startDataNone" ms-visible="assemblyData==null">
							<img src="../../images/hostNone.png" />
							<p>请扫描整机物联码后进行装配</p>
						</div>
						<div class="mui-card" ms-visible="assemblyData!=null" style="box-shadow: 0px 2px 4px 0px #BDC2C2;">
							<div class="mui-card-header"><span class="mui-ellipsis"><i class="mui-icon"><img src="../../images/Bitmap.png"></i><span class="pro-title openDia" ms-attr="{'data-index':-2}">{{assemblyData.HostProdInnerCode}}</span></span>
								<span ms-if="assemblyData.PartList==null||assemblyData.PartList.length==0" class="mui-pull-right pro-state state-ing">正在装配</span>
								<span ms-if="assemblyData.PartList!=null && assemblyData.PartList.length>0" class="mui-pull-right pro-state state-ing conparts">正在装配<i ms-class="['mui-icon',isdown==1?'mui-icon-arrowdown':'mui-icon-arrowup']" style="font-size: 20px;"></i></span></div>
							<div ms-class="['mui-card-content',assemblyData.State==1?'dis-block':'dis-none']">
								<ul class="mui-table-view">
									<li class="mui-table-view-cell mui-media" ms-for="(indexchi,parts) in assemblyData.PartList" ms-attr="{'data-partindex':indexchi,'data-index':-1}">
										<a href="javascript:;">
											<div class="mui-media-object mui-pull-right codenumber mui-ellipsis">{{parts.PartProdInnerCode}}</div>
											<div class="mui-media-body">
												<p class="mui-ellipsis" style="font-size: 14px;color: #323232;">{{parts.PartProdName}}</p>
												<p class='mui-ellipsis sku'>{{parts.PartSkuName}}</p>
											</div>
										</a>
									</li>
								</ul>

							</div>
							<!--<div class="mui-card-footer" style="display: block">
								<div class="mui-row">
									<div class="mui-col-sm-4 mui-col-xs-4 right-boder openParts" ms-attr="{'data-index':-1}">
										手工添加配件
									</div>
									<div class="mui-col-sm-4 mui-col-xs-4 right-boder scanParts">
										扫码添加配件
									</div>
									<div class="mui-col-sm-4 mui-col-xs-4 endAssembly" ms-attr="{'data-index':-1,'GroupHostAssID':assemblyData.GroupHostAssID}">
										结束我的装配
									</div>
								</div>
							</div>-->

						</div>
					</div>

				</div>
			</div>
		</div>
		<div class="show-more">
			<div style="flex: 1;margin-right: 32px;" class="openParts" data-index='-1'><span>{{assemblyData!=null?'手工添加配件':'手工添加主机'}}</span></div>
			<!--没有主机时添加主机，有 时添加配件-->

			<div style="flex: 1;margin-left: 32px;" ms-class="[assemblyData!=null?'endAssembly':'enable-color']" data-index='-1'><span>结束装配</span></div>
			<!--没有主机时无操作-->

			<div class="saomiao"><span class="icon-saomiao"></span>
			</div>
		</div>

		<!--整机信息弹框  start-->
		<div id="adpopover" class="mui-popover bottomPopover">
			<ul class="data-group" style="margin-top: 3px;">
				<li class="data-row first" style="background: #F6FBFF;">
					<a class="mui-icon mui-icon-closeempty" href="#adpopover"></a>
					<div class="body">
						<div class="mui-ellipsis">
							<span class="label-gray font-14">整机确认</span>
						</div>

					</div>
				</li>
				<li ms-class="['data-row mustb',deleteHostID==0?'selProduct':'']" type="1">
					<label class="label-gray">产品名称</label>
					<span ms-if="deleteHostID==0" class="mui-icon mui-icon mui-icon-arrowright selProducticon" style=""></span>
					<div class="body">
						<div class="edit">
							<input class="needsclick" ms-duplex="hostData.HostProdName" readonly="readonly" contenteditable="false" placeholder="请选择产品名称">

						</div>
					</div>

				</li>
				<li class="data-row">
					<label class="label-gray">规格型号</label>
					<div class="body">
						<div class="edit">
							<input class="needsclick" type="text" ms-duplex="hostData.HostSkuName" readonly="readonly" contenteditable="false" placeholder="请选择规格型号" />
						</div>
					</div>
				</li>
				<li class="data-row mustb">
					<label class="label-gray mui-ellipsis">{{factCodeName}}</label>
					<div class="body">
						<div class="edit">
							<input class="needsclick" id='hostfactoryCode' type="text" autofocus="autofocus" maxlength="30" ms-attr="{readonly:deleteHostID>0 && readonly,'placeholder':'请输入'+factCodeName}" ms-duplex="hostData.HostProdInnerCode" contenteditable="true" />
						</div>
					</div>
				</li>
			</ul>
			<div class="addelment">
				<a type="button" ms-if="deleteHostID==0" class="font-15 mui-btn mui-btn-block saveHost">确认</a>

				<a type="button" ms-if="deleteHostID>0" class="font-15 mui-btn mui-btn-block del-button deleteHost">取消装配</a>
			</div>
		</div>
		<!--整机信息弹框  end-->

		<!--零件信息弹框  start-->
		<div id="partspopover" class="mui-popover partsPopover">
			<ul class="data-group" style="margin-top: 3px;">
				<li class="data-row first" style="background: #F6FBFF;">
					<a class="mui-icon mui-icon-closeempty" href="#partspopover"></a>
					<div class="body">
						<div class="mui-ellipsis">
							<span class="label-gray font-14">配件确认</span>
						</div>

					</div>
				</li>
				<li ms-class="['data-row mustb',(deletePartID>0 && partData.PartMDCode!='')?'':'selProduct']" type="2">
					<label class="label-gray">配件名称</label>
					<span ms-if="(deletePartID==0 || partData.PartMDCode=='')" class="mui-icon mui-icon mui-icon-arrowright selProducticon"></span>
					<div class="body">
						<div class="edit">
							<input class="needsclick" readonly="readonly" ms-duplex="partData.PartProdName" contenteditable="false" placeholder="请选择配件名称">

						</div>
					</div>

				</li>
				<li class="data-row">
					<label class="label-gray">规格型号</label>
					<div class="body">
						<div class="edit">
							<input class="needsclick" type="text" readonly="readonly" ms-duplex="partData.PartSkuName" contenteditable="false" placeholder="请选择规格型号" />
						</div>
					</div>
				</li>
				<li class="data-row mustb">
					<label class="label-gray mui-ellipsis">{{factCodeName}}</label>
					<div class="body">
						<div class="edit">
							<input class="needsclick" id="factoryCode" type="text" autofocus="autofocus" maxlength="30" ms-duplex="partData.PartProdInnerCode" contenteditable="true" ms-attr="{readonly:(deletePartID>0 && partData.PartMDCode!='') && readonly,'placeholder':'请输入'+factCodeName}" />
						</div>
					</div>
				</li>
				<li class="data-row mui-tip" ms-if="deletePartID>0 && partData.PartMDCode!=''">

					<span>温馨提示：</span>该配件已锁定只能查看

				</li>
			</ul>
			<div class="addelment">
				<a type="button" ms-if="deletePartID==0" class="font-15 mui-btn mui-btn-block savePart">确认</a>
				<a type="button" ms-if="deletePartID>0 && partData.PartMDCode==''" class="font-15 mui-btn mui-btn-block del-button part-right-btn deletePart">删除配件</a>
				<a type="button" ms-if="deletePartID>0 && partData.PartMDCode==''" class="font-15 mui-btn mui-btn-block part-left-btn savePart">修改</a>
				<a type="button" ms-if="deletePartID>0 && partData.PartMDCode!=''" class="font-15 mui-btn mui-btn-block del-button deletePart">删除配件</a>
			</div>
		</div>
		<!--零件信息弹框  end-->
		<script src="../../js/mui.min.js"></script>
		<script src="../../js/avalon.js"></script>
		<script src="../../js/utils.js"></script>
		<script src="../../js/rpc.js"></script>
		<script>
			var scroll = mui('.mui-scroll-wrapper').scroll();
			//手持设备扫描回调事件
			function scancallbackFun(code) {
				app.delScanResult(0, code);
			}
			mui(".mui-content").on('tap', '.conparts', function() {
				//状态切换 显隐零件功能  
				var obj = this.parentNode.nextElementSibling
				var icon = this.children[0].classList;
				if(obj.classList.contains('dis-none')) {
					obj.classList.remove('dis-none');
					obj.classList.add('dis-block');

					//图标
					app.isdown = 0;
				} else {

					obj.classList.remove('dis-block');
					obj.classList.add('dis-none');

					//图标
					app.isdown = 1;
				}
				obj.classList.add('mui-card-content');

			}).on('tap', 'mui-icon-closeempty', function() {
				document.activeElement.blur();
			})
			mui(".show-more").on('tap', '.openParts', function() {
				//手工添加零件—— 按钮 独有
				var index = this.getAttribute("data-index");
				//处理  判断是否有正在装配的主机，有 装配配件 ，没有 默认装配整机  todo
				if(!app.checkAssIng()) {
					app.openDia('-1');
				} else {
					app.openParts(index, -1);
				}
			})
			mui(".mui-content").on('tap', '.mui-media', function() {
				//点击零配件行  实现可以删除
				var index = this.getAttribute("data-index");
				var partindex = this.getAttribute("data-partindex");
				app.openParts(index, partindex);
			})

			mui(".ms-controller").on('tap', '.openDia', function() {
					//点击主机名称 修改删除弹框  -2装配中的  -1 新增  其它 列表
					var index = this.getAttribute("data-index");
					app.openDia(index);
				}).on('tap', '.assRecord', function() {
					//删除主机
					app.assRecord();
				})
				.on('tap', '.saomiao', function() {
					//删除主机
					app.scan(1, 0);
				})

			mui(".mui-content").on('tap', '.scanParts', function() {
				//扫描添加零配件scanParts 装配独有
				var index = this.getAttribute("data-index");
				app.assemblyIndex = index;
				app.deletePartID = 0;
				app.scan(2, index);
			})
			mui(".show-more").on('tap', '.endAssembly', function() {
				//结束配件  -1
				app.endAssembly();
			})
			mui(".mui-popover").on('tap', '.deleteHost', function() {
				//删除主机
				app.deleteHost();
			}).on('tap', '.saveHost', function() {
				//保存主机
				app.saveHost();
			}).on('tap', '.savePart', function() {
				//保存配件
				app.savePart(true);
			}).on('tap', '.deletePart', function() {
				//删除配件
				app.deletePart();
			})
			mui(".mui-bar-nav").on('tap', '.changeAudit', function() {
				//控制声音
				var type = this.getAttribute("type");
				app.changeAudit(type);
			})
			mui(".mui-popover").on('tap', '.selProduct', function() {
				//结束配件
				document.activeElement.blur();
				var type = parseInt(this.getAttribute("type"));
				//type：1主机  2零件  isall：false(不显示全部)   默认true
				app.seltype = type;
				openWindow("../problib/index.html?state=selsku&isall=false&type=" + type + "", {
					callback: 'selProduct'
				}, 'problib-index.html');

			})
			var app = avalon.define({
				$id: "productCtrl",
				GroupID: 0, //小组ID
				assemblyIndex: -1, //正在装配的主机索引  -1没有
				assemblyData: null, //正在装配的 主机信息
				isdown: 0,
				isaudit: 0, //是否开启语音提示 0 开启 1 静音
				factCodeName: '出厂编号',
				opertionIng: false, //是否操作中
				isSelfPart: true, //是否本企业配件 用来控制是否记录
				seltype: '',
				/*保存上一次选择*/
				lastPart: {
					"PartProdID": "", //配件产品id
					"PartProdName": "", //配件名称
					"PartSkuID": "", //配件型号id
					"PartSkuName": "", //配件型号名称
				}, //上一次提交的零件
				lastHost: {
					"HostProdID": "", //产品id
					"HostProdName": "", //产品名称
					"HostSkuID": "", //主机型号id
					"HostSkuName": "", //主机型号名称
				}, //上一次提交的整机
				PageIndex: 1,
				scanType: 1, //扫描的主机还是配件 1 主机，2 配件
				deletePartID: 0, //要删除的零件id
				deleteHostID: 0, //要删除的主机id
				endCode: 'endAssembly', //结束装配标示码
				//弹框界面主机信息
				hostData: {
					"ID": 0,
					"GroupID": 0, //小组ID
					"HostMDCode": "", //主机迈迪码
					"HostProdID": "", //产品id
					"HostProdName": "", //产品名称
					"HostSkuID": "", //主机型号id
					"HostSkuName": "", //主机型号名称
					"HostProdInnerCode": "" //主机出厂编号
				}, //正在装配的主机信息
				//弹框配件保存信息
				partData: {
					"ID": 0,
					"HostMDCode": "", //主机迈迪码
					"HostProdID": "", //主机产品id
					"HostProdName": "", //主机名称
					"HostSkuID": "", //主机型号id
					"HostSkuName": "", //主机型号名称
					"HostProdInnerCode": "", //主机出场编号

					"PartMDCode": "", //配件迈迪码
					"PartProdID": "", //配件产品id
					"PartProdName": "", //配件名称
					"PartSkuID": "", //配件型号id
					"PartSkuName": "", //配件型号名称
					"PartProdInnerCode": "", //配件出厂编号
					"GroupHostAssID": 0 //装配id
				},
				checkAssIng: function() {
					//检查当前是否有正在装配的主机
					var res = false;
					if(app.assemblyData != null) {
						res = true;
					} else {
						res = false;
						app.assemblyData = null;
					}
					return res;
				},
				openDia: function(index) {
					if(index == '-1') { //新增主机
						app.deleteHostID = 0;
						app.hostData.ID = 0;
						app.hostData.GroupID = app.GroupID;
						app.hostData.HostMDCode = '';
						app.hostData.HostProdID = app.lastHost.HostProdID || '';
						app.hostData.HostProdName = app.lastHost.HostProdName || '';
						app.hostData.HostSkuID = app.lastHost.HostSkuID || '';
						app.hostData.HostSkuName = app.lastHost.HostSkuName || '';
						app.hostData.HostProdInnerCode = '';
					} else {

						var obj = null;
						if(index == -2) { //正在装配的 主机
							obj = app.assemblyData.$model;
							app.hostData.ID = obj.GroupHostAssID;
							app.hostData.GroupID = app.GroupID;
							app.hostData.HostMDCode = obj.HostMDCode;
							app.hostData.HostProdID = obj.HostProdID;
							app.hostData.HostProdName = obj.HostProdName;
							app.hostData.HostSkuID = obj.HostSkuID;
							app.hostData.HostSkuName = obj.HostSkuName;
							app.hostData.HostProdInnerCode = obj.HostProdInnerCode;

							//启用删除功能
							app.deleteHostID = obj.GroupHostAssID;
						}

					}
					mui('.bottomPopover').popover('show');
				},
				//零件信息弹框
				openParts: function(index, partIndex) {
					var elem = document.getElementById('factoryCode');
					elem.focus();

					app.deletePartID = 0;
					var obj = null;
					if(index == -1) {
						obj = app.assemblyData.$model;
						app.partData.HostMDCode = obj.HostMDCode;
						app.partData.HostProdID = obj.HostProdID;
						app.partData.HostProdName = obj.HostProdName;
						app.partData.HostSkuID = obj.HostSkuID;
						app.partData.HostSkuName = obj.HostSkuName;
						app.partData.HostProdInnerCode = obj.HostProdInnerCode;
						app.partData.GroupHostAssID = obj.GroupHostAssID;
					}

					if(partIndex == -1) {
						app.partData.ID = 0;
						app.partData.PartMDCode = '';
						app.partData.PartProdID = app.lastPart.PartProdID || '';
						app.partData.PartProdName = app.lastPart.PartProdName || '';
						app.partData.PartSkuID = app.lastPart.PartSkuID || '';
						app.partData.PartSkuName = app.lastPart.PartSkuName || '';
						app.partData.PartProdInnerCode = '';
					} else {
						app.partData.ID = obj.PartList[partIndex].AssembleID;
						app.partData.PartMDCode = obj.PartList[partIndex].PartMDCode;
						app.partData.PartProdID = obj.PartList[partIndex].PartProdID;
						app.partData.PartProdName = obj.PartList[partIndex].PartProdName;
						app.partData.PartSkuID = obj.PartList[partIndex].PartSkuID;
						app.partData.PartSkuName = obj.PartList[partIndex].PartSkuName;
						app.partData.PartProdInnerCode = obj.PartList[partIndex].PartProdInnerCode;

						app.deletePartID = obj.PartList[partIndex].AssembleID;
						//删除功能显示
					}

					mui('.partsPopover').popover('show');

				},
				scan: function(type, index) {
					app.scanType = type
					//调用扫描页面 type 1 主机 2.配件，回调方法//app.delScanResult(code)
					openWindow("scan/scan.html", {
						callback: "app.delScanResult"
					});
				},
				//结束装配  还有一种扫描结束码结束正在装配的主机
				endAssembly: function() {
					//判断是否有  零件 做出提示  是否有正在装配的 主机 
					if(app.checkAssIng()) {

						if(!app.opertionIng) {
							app.opertionIng = true;
							if(app.assemblyData.PartList.length == 0) {
								mui.confirm("该主机下没有配件，确认结束装配吗？", function(e) {
									if(e.index == 0) {
										app.endAssemblyStart()
									} else {
										app.opertionIng = false;
									}
								})
							} else {
								app.endAssemblyStart()
							}
						}

					} else {
						mui.toast('当前没有正在装配的主机！');
					}
				},
				endAssemblyStart: function() {
					var url = MdAppUrl.Api50 + "/api/v1/Assemble/EndAssemble?groupHostAssId=" + app.assemblyData.GroupHostAssID;
					getAjaxData(url, function(data) {
						app.opertionIng = false;
						if(data.State == 1) {
							app.assemblyData = null;
							if(app.isaudit == 0) {
								playerTip(3);
							}
							mui.toast('结束装配！');
						} else {
							mui.toast(data.ErrorMessage);
						}
					}, true)
				},

				//扫描结果回调
				delScanResult: function(type, code) {
					var m_url = 'http://m.maidiyun.com';
					var my_url = 'http://m.my3dparts.com';
					var m_url_2 = "http://md9.vc";
					if(code) {
						if(code == app.endCode) {
							if(app.assemblyData == null) {
								mui.toast('没有需要结束的装配！');
							} else {
								//结束正在装配的主机
								var GroupHostAssID = app.assemblyData.GroupHostAssID;
								app.endAssembly();
							}
						} else {
							if(code.match(/^http(|s):\/\//g)) {
								//如果是带有m.maidiyun.com或m.my3dparts.com标识的网址，说明是迈迪的专有码
								if(code.indexOf(m_url) >= 0 || code.indexOf(my_url) >= 0 || code.indexOf(m_url_2) >= 0) {
									var params = code.split('?');
									if(params.length > 1) {
										code = params[1];
									}
								}
							}
							//处理扫描结果  是否有正在装配的整机，有 作为零件显示，没有作为整机
							//默认为迈迪码  获取详情，没有则默认为出厂编号 弹框显示

							var url = MdAppUrl.Api50 + "/api/v1/MdCode/GetProdInfoByMdCode?CompID=" + user.CompID + "&code=" + code;
							getAjaxData(url, function(data) {
								if(data.State == 1) {
									if(data.Data.ProdID != '' && data.Data.ProdID != null) {
										//如果没有正在装配的主机  默认主机
										if(!app.checkAssIng()) {
											//判断是不是本企业的主机

											if(user.CompID == data.Data.CompID) {
												app.hostData.ID = 0;
												app.hostData.GroupID = app.GroupID;
												app.hostData.HostMDCode = code;
												app.hostData.HostProdID = data.Data.ProdID;
												app.hostData.HostProdName = data.Data.ProdName;
												app.hostData.HostSkuID = data.Data.SkuID;
												app.hostData.HostSkuName = data.Data.SkuName;
												app.hostData.HostProdInnerCode = data.Data.InnerCode;
												//如果出厂编号为空时 处理  
												if(data.Data.InnerCode == '') {
													app.deleteHostID = 0;
													mui('.bottomPopover').popover('show');
												} else {
													//保存主机 装配信息
													app.saveHost();
												}
											} else {
												mui.toast('请扫描本企业的主机！');
											}

										} else {

											//零件装配  list 塞值页面显示 
											var obj = app.assemblyData.$model;
											app.partData.ID = 0;
											app.partData.HostMDCode = obj.HostMDCode;
											app.partData.HostProdID = obj.HostProdID;
											app.partData.HostProdName = obj.HostProdName;
											app.partData.HostSkuID = obj.HostSkuID;
											app.partData.HostSkuName = obj.HostSkuName;
											app.partData.HostProdInnerCode = obj.HostProdInnerCode;
											app.partData.GroupHostAssID = obj.GroupHostAssID;

											app.partData.PartMDCode = code;
											app.partData.PartProdID = data.Data.ProdID;
											app.partData.PartProdName = data.Data.ProdName;
											app.partData.PartSkuID = data.Data.SkuID;
											app.partData.PartSkuName = data.Data.SkuName;
											app.partData.PartProdInnerCode = data.Data.InnerCode;
											//配件迈迪码 不能等于主机迈迪码
											if(app.partData.PartMDCode != '' && (app.partData.HostMDCode == app.partData.PartMDCode)) {
												mui.toast('配件不能与主机相同！');
												return false;
											}
											if(app.partData.PartMDCode == '' && app.partData.HostProdID == app.partData.PartProdID) {
												mui.toast('配件不能与主机相同！');
												return false;
											} else if(app.isExistPart()) {
												mui.toast('配件已被装配！');
												return false;
											} else {
												if(user.CompID != data.Data.CompID) {
													app.isSelfPart = false;
												} else {
													app.isSelfPart = true;
												}

												if(data.Data.InnerCode == '') {
													app.deletePartID = 0;
													mui('.partsPopover').popover('show');
												} else {
													//保存配件
													app.savePart(false);
												}
											}

										}
									} else {
										app.delEmptyAss(code); //查不到产品信息
									}
								} else {
									//查不到 产品信息  默认为出厂编号 弹框显示
									app.delEmptyAss(code);
								}
							})
						}
					}
				},
				delEmptyAss: function(code) {
					//处理不是 扫描迈迪码的情况
					if(!app.checkAssIng()) {
						app.hostData.ID = 0;
						app.hostData.GroupID = app.GroupID;
						app.hostData.HostMDCode = '';
						app.hostData.HostProdID = '';
						app.hostData.HostProdName = '';
						app.hostData.HostSkuID = '';
						app.hostData.HostSkuName = '';
						app.hostData.HostProdInnerCode = code;

						app.deleteHostID = 0;
						mui('.bottomPopover').popover('show');
					} else {
						var obj = app.assemblyData.$model;
						app.partData.ID = 0;
						app.partData.HostMDCode = obj.HostMDCode;
						app.partData.HostProdID = obj.HostProdID;
						app.partData.HostProdName = obj.HostProdName;
						app.partData.HostSkuID = obj.HostSkuID;
						app.partData.HostSkuName = obj.HostSkuName;
						app.partData.HostProdInnerCode = obj.HostProdInnerCode;
						app.partData.GroupHostAssID = obj.GroupHostAssID;

						app.partData.PartMDCode = '';
						app.partData.PartProdID = '';
						app.partData.PartProdName = '';
						app.partData.PartSkuID = '';
						app.partData.PartSkuName = '';
						app.partData.PartProdInnerCode = code;

						app.deletePartID = 0;
						mui('.partsPopover').popover('show');
					}
				},
				isExistPart: function() {
					//判断当前零件是否已存在 正在装配的主机中
					var res = false;
					var part = app.assemblyData.PartList;

					for(var i = 0; i < part.length; i++) {
						//						if(app.partData.PartProdInnerCode == part[i].PartProdInnerCode) {
						//							res = true;
						//							break;
						//						}
						//或者迈迪码
						if(app.partData.PartMDCode != '' && (app.partData.PartMDCode == part[i].PartMDCode)) {
							res = true;
							break;
						}
					}
					return res;
				},
				//保存配件信息isRem  是否记录选择
				savePart: function(isRem) {
					//判断是否为空
					if(!app.partData.PartProdID > 0) {
						mui.toast('请选择配件！');
						return false;
					}
					app.partData.PartProdInnerCode = document.getElementById('factoryCode').value.trim();
					if(app.partData.PartProdInnerCode == '') {
						mui.toast('请填写' + app.factCodeName + '！');
						return false;
					}
					//配件迈迪码 不能等于主机迈迪码
					if(app.partData.PartMDCode != '' && (app.partData.HostMDCode == app.partData.PartMDCode)) {
						mui.toast('配件不能与主机相同！');
						return false;
					}
					//迈迪码为空的时候 产品不能相同
					if(app.partData.PartMDCode == '' && (app.partData.HostProdID == app.partData.PartProdID)) {
						mui.toast('配件不能与主机相同！');
						return false;
					}
					//					if(app.isExistPart()) {
					//						mui.toast('配件已存在！');
					//						return false;
					//					}
					if(!app.opertionIng) {
						app.opertionIng = true;
						showWaiting();
						var saveurl = MdAppUrl.Api50 + "/api/v1/Assemble/SavePartAssemble";
						postAjaxData(saveurl, app.partData.$model, function(res) {
							app.opertionIng = false;
							hideWaiting();
							if(res.State == 1) {
								document.activeElement.blur();
								//获取本人 装配列表
								if(app.isaudit == 0) {
									playerTip(2);
								}
								mui('.partsPopover').popover('hide');
								app.getAssemblyIng(1); //重新读取 正在装配的主机
								if(app.isSelfPart) {
									app.lastPart.PartProdID = app.partData.PartProdID; //配件产品id
									app.lastPart.PartProdName = app.partData.PartProdName; //配件名称
									app.lastPart.PartSkuID = app.partData.PartSkuID; //配件型号id
									app.lastPart.PartSkuName = app.partData.PartSkuName; //配件型号名称
								}
								app.isSelfPart = true;
							} else {
								mui.toast(res.ErrorMessage);
							}
						}, true)
					}
				},
				saveHost: function() {
					//判断是否为空
					if(!app.hostData.HostProdID > 0) {
						mui.toast('请选择主机！');
						return false;
					}
					app.hostData.HostProdInnerCode = document.getElementById('hostfactoryCode').value.trim();
					if(app.hostData.HostProdInnerCode == '') {
						mui.toast('请填写' + app.factCodeName + '！');
						return false;
					}
					var saveurl = MdAppUrl.Api50 + "/api/v1/Assemble/SaveGroupHostAss";
					if(!app.opertionIng) {
						app.opertionIng = true;
						postAjaxData(saveurl, app.hostData.$model, function(res) {
							app.opertionIng = false;
							if(res.State == 1) {
								document.activeElement.blur();
								//获取本人 装配列表
								mui('.bottomPopover').popover('hide');
								if(app.isaudit == 0) {
									playerTip(1);
								}
								//todo 获取正在装配的数据
								app.getAssemblyIng();

								app.lastHost.HostProdID = app.hostData.HostProdID; //产品id
								app.lastHost.HostProdName = app.hostData.HostProdName; //产品名称
								app.lastHost.HostSkuID = app.hostData.HostSkuID; //主机型号id
								app.lastHost.HostSkuName = app.hostData.HostSkuName; //主机型号名称
							} else {
								mui.toast(res.ErrorMessage);
							}
						}, true)
					}
				},
				deletePart: function() {
					//删除配件
					if(!app.opertionIng) {
						app.opertionIng = true;
						mui.confirm("确认删除该配件吗？", function(e) {
							if(e.index == 0) {
								var url = MdAppUrl.Api50 + "/api/v1/Assemble/DelPartAssemble?assembleId=" + app.deletePartID;
								getAjaxData(url, function(data) {
									app.opertionIng = false;
									if(data.State == 1) {
										mui('.partsPopover').popover('hide');
										mui.toast('删除成功！');
										app.deletePartID = 0;
										app.getAssemblyIng();
									} else {
										mui.toast('删除失败！');
									}
								}, true)
							} else {
								app.opertionIng = false;
							}
						});
					}

				},
				deleteHost: function() {
					//删除主机  
					if(!app.opertionIng) {
						app.opertionIng = true;
						mui.confirm("确认取消装配吗？", function(e) {
							if(e.index == 0) {
								var url = MdAppUrl.Api50 + "/api/v1/Assemble/DelGroupHostAss?groupHostAssId=" + app.deleteHostID;
								getAjaxData(url, function(data) {
									app.opertionIng = false;
									if(data.State == 1) {
										mui('.bottomPopover').popover('hide');
										app.getAssemblyIng(1); //重新读取 正在装配的主机
										mui.toast('取消成功！');
										app.deleteHostID = 0;
									} else {
										mui.toast(data.ErrorMessage);
									}
								}, true)
							} else {
								app.opertionIng = false;
							}
						});
					}
				},
				getAssemblyIng: function(type) {
					//获取当前用户正在装配的主机信息
					var url = MdAppUrl.Api50 + "/api/v1/Assemble/GetGroupHost_PartInfo?groupId=" + app.GroupID;
					getAjaxData(url, function(data) {
						hideWaiting();
						if(data.State == 1) {
							app.assemblyData = data.Data;
							//重新计算布局值，最大滚动的高度等等
							if(type == 1) {
								scroll.reLayout();
								//滚动到底部
								scroll.scrollToBottom(100);
							}
						} else {
							app.assemblyData = null;
							//mui.toast(data.ErrorMessage);
						}
					}, true)
				},
				changeAudit: function(type) {
					//调用接口设置静音
					var url = MdAppUrl.Api50 + "/api/v1/Assemble/SetMute";
					if(type == 1) {
						url = MdAppUrl.Api50 + "/api/v1/Assemble/CancelMute";
					}

					getAjaxData(url, function(data) {
						if(data.State == 1) {
							app.isaudit = type == 1 ? 0 : 1;
						} else {
							mui.toast(data.ErrorMessage);
						}
					}, true)
				},
				getAudit: function() {
					//读取静音
					var url = MdAppUrl.Api50 + "/api/v1/Assemble/IsMute";

					getAjaxData(url, function(data) {
						if(data.State == 1) {
							app.isaudit = data.Data; //1是静音 0 开启
						} else {
							mui.toast(data.ErrorMessage);
						}
					}, true)
				}
			})
			mui.plusReady(function() {
				user.ready(function() {
					app.factCodeName = user.InnerCodeName;
					showWaiting();
					app.getAudit();
					setTimeout(function() {
						app.getAssemblyIng();
					}, 300);
				});
			})
			avalon.filters.getAssState = function(a) {
				var state = '';
				switch(a) {
					case 1:
						state = '<span class="state-ing">正在装配</span>';
						break;
					case 2:
						state = '<span class="state-wait">等待装配</span>';
						break;
					case 3:
						state = '<span class="state-done">已装完</span>';
						break;

				}
				return state;
			}

			function playerTip(type) { //播放音乐 msg.wav
				//type 1.开始装配，2.装配件，3.结束个人装配
				var path = "";
				switch(type) {
					case 1:
						path = '_www/src/audio/start.wav';
						break;
					case 2:
						path = '_www/src/audio/ing.wav';
						break;
					case 3:
						path = '_www/src/audio/end.wav';
						break;
					default:
						break;
				}

				player = plus.audio.createPlayer(path);

				player.play(function() { //播放完成回调 
					stopAudio(true);
				}, function(e) { //失败回调 
					stopAudio(true);

				});
			}

			function stopAudio(isautostop) {
				if(player && !isautostop) {
					player.stop();
				}
			}

			function selProduct(res) {
				res.MatCode = res.MatCode == undefined ? '' : res.MatCode;
				if(app.seltype == 1) { //产品
					app.hostData.ID = app.deleteHostID;
					app.hostData.HostMDCode = '';
					app.hostData.HostProdID = res.ProdID;
					app.hostData.HostProdName = res.ProdName;
					app.hostData.HostSkuID = res.SkuID;
					app.hostData.HostSkuName = res.SkuName;
					//app.hostData.HostProdInnerCode = res.ProdID;
				} else {
					if(app.partData.PartMDCode == '' && app.partData.HostProdID == res.ProdID) {
						mui.toast('配件不能与主机相同！');
						return false;
					} else {
						app.partData.ID = app.deletePartID;
						app.partData.PartMDCode = '';
						app.partData.PartProdID = res.ProdID;
						app.partData.PartProdName = res.ProdName;
						app.partData.PartSkuID = res.SkuID;
						app.partData.PartSkuName = res.SkuName;
					}
				}
			}
			mui('body').on('hidden', '.mui-popover', function(e) {
				document.activeElement.blur();
			});
		</script>
	</body>

</html>