<!doctype html>
<html id="MdTong">

	<head>
		<meta charset="UTF-8">
		<title>安装调试</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1, user-scalable=no">
		<link href="../../css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../css/common.css" />
		<link rel="stylesheet" href="../../icon-font/iconfont.css" />
		<style type="text/css">
			.data-group .data-row label {
				padding-right: 8px;
			}
			
			.data-group:first-child {
				margin-top: 0;
			}
			
			.mui-table-view .mui-media-object {
				border: none;
			}
			
			.mui-table-view:before,
			.mui-table-view:after {
				content: none;
			}
			
			.mui-table-view .mui-table-view-cell {
				padding: 8px 16px;
				height: 71px;
			}
			
			.mui-table-view .mui-table-view-cell .mui-media-object {
				line-height: 71px;
				background-color: #FFFFFF;
				width: 55px;
				height: 55px;
				max-width: 55px;
				background-size: 50px;
			}
			
			.mui-ellipsis {
				white-space: nowrap !important;
			}
			
			.equ-title {
				/*line-height: 48px;*/
				font-size: 1.5rem;
				color: #000000;
			}
			
			.equ-sub {
				line-height: 16px;
				font-size: 1.2rem;
				color: #AAAAAA;
				font-family: MicrosoftYaHei;
			}
			
			.mui-table-view .mui-table-view-cell label,
			.mui-table-view .mui-table-view-cell .opt {
				position: absolute;
				font-size: 1.2rem !important;
				top: 50%;
				-webkit-transform: translateY(-50%);
				transform: translateY(-50%);
				overflow: hidden;
				margin: 0;
			}
			
			.mui-table-view .mui-table-view-cell .opt,
			.data-group .data-row .opt {
				color: #AEAEAE;
				top: 50%;
			}
			
			.mui-table-view .mui-table-view-cell .opt:active {
				color: #169BD5;
			}
			
			.mui-table-view .mui-table-view-cell .opt,
			.mui-table-view .mui-table-view-cell .body.arrow:after {
				font-size: 1.7rem;
				right: 0;
				padding: 10px 14px 11px 10px;
			}
			
			.mui-table-view-cell:after {
				background-color: #ECECEC;
			}
			
			.mui-table-view .mui-table-view-cell:after {
				left: 10px;
				right: 10px;
			}
			
			.imgslist {
				float: left;
				width: 55px;
				height: 55px;
				margin-right: 10px;
				background-size: cover !important;
			}
			
			.mui-row .signBtn {
				position: relative;
				width: 50%;
				text-align: center;
				height: 44px;
				line-height: 44px;
			}
			
			.right-save {
				font-size: 1.4rem;
				line-height: 40px;
				padding: 3px 2px;
				text-align: center;
				color: #000000;
			}
		</style>
	</head>

	<body ng-controller="DebugEditController">
		<div id="signatureparent" style="display: none;margin: 60px 0;">
			<header class="mui-bar mui-bar-nav">
				<a class="right-save">客户确认签名</a>
			</header>
			<div id="signature"></div>
			<ul class="mui-table-view mui-row">
				<li class="signBtn mui-media mui-col-sm-6 mui-col-xs-6" style="background: #FFFFFF;color: #3296FA;" ng-click="signature('clear')">清除签名</li>
				<li class="signBtn mui-media mui-col-sm-6 mui-col-xs-6" style="background: #3296FA;color: #FFFFFF;" ng-click="signature('save')">保存签名</li>
			</ul>
		</div>
		<header class="mui-bar mui-bar-nav" id="header">
			<a class="mui-action-back mui-icon icon-back mui-pull-left mui-ellipsis" style="max-width: 70vw;" ng-bind="title"></a>
		</header>
		<div class="mui-scroll-wrapper equiFM" style="margin-bottom: 40px;display: none;" id="content">
			<ul class="data-group">
				<p class="data-group-tip mt10">相关设备</p>
				<li class="data-row must">
					<label>调试设备</label>
					<p class="opt md-icon font-15" ng-click="scan('scan')" ng-if="!isscan">
						<span class="icon-saoyisao"></span>
					</p>
					<p class="opt md-icon font-15" ng-click="toProdInfoPage(prodInfo.ProdID)" ng-if="isscan">
						<span class="icon-right"></span>
					</p>
					<div class="body" ng-click="toProdInfoPage(prodInfo.ProdID)">
						<span class="placeholder" ng-show="!prodInfo.ProdID">请扫描调试设备</span>
						<span ng-bind="prodInfo.ProdName | formatProdInfo:prodInfo.SkuName" ng-show="prodInfo.ProdID"></span>
					</div>
				</li>
				<li class="data-row" ng-class="{'must':!(prodInfo.MDCode&&prodInfo.InnerCode)}">
					<label ng-bind="InnerCodeName"></label>
					<div class="body">
						<!--<input id="prodInnerCode" class="needsclick" ng-model="customer.compMdt" placeholder="{{'请输入'+InnerCodeName}}" lenlimit="30" ng-blur="getcuinfo()" onkeyup="this.innerText=this.innerText.replace(/[\u4e00-\u9fa5]/ig,'');moveEnd(this,true);"></input>-->
						<!--<input ng-model="customer.compMdt" placeholder="请输入迈迪通号" lenlimit="15" ng-blur="getcuinfo()"></input>-->
						<div class="edit" ng-show="!(prodInfo.MDCode&&prodInfo.InnerCode)">
							
							<div id="prodInnerCode" class="needsclick" placeholder="{{'请输入'+InnerCodeName}}" ng-blur="getcuinfo()" contenteditable="true" lenlimit="30" onkeyup="this.innerText=this.innerText.replace(/[\u4e00-\u9fa5]/ig,'');moveEnd(this,true);"></div>
						</div>
						<span ng-if="prodInfo.MDCode&&prodInfo.InnerCode" ng-bind="prodInfo.InnerCode"></span>
					</div>
				</li>
				<li class="data-row">
					<label>设备数量</label>
					<div class="body">
						<input type="text" style="width:100%;" ng-precision="0" input-decimal-kong lenlimit="3" maxlength="3" ng-model="Quantity" placeholder="请输入设备数量">
					</div>
				</li>
				<li class="data-row" ng-show="ISJJComp">
					<label>滤板类型</label>
					<div class="body">
						<div class="edit">
							<div ng-model-div-text="FilterPlateType" class="needsclick" placeholder="请输入滤板类型" contenteditable="true" lenlimit="10"></div>
						</div>
					</div>
				</li>
				<li class="data-row" ng-show="ISJJComp">
					<label>滤布型号</label>
					<div class="body">
						<div class="edit">
							<div ng-model-div-text="FilterClothType" class="needsclick" placeholder="请输入滤布型号" contenteditable="true" lenlimit="10"></div>
						</div>
					</div>
				</li>
			</ul>
			<ul class="data-group">
				<li class="data-row must">
					<label>工作内容</label>
					<div class="body">
						<div class="edit">
							<div ng-model-div-text="JobContent" class="needsclick" placeholder="请输入工作内容" contenteditable="true" lenlimit="400"></div>
						</div>
					</div>
				</li>
				<li class="data-row" ng-show="ISJJComp">
					<label>过滤工艺描述</label>
					<div class="body">
						<div class="edit">
							<div ng-model-div-text="FilterTechDes" class="needsclick" placeholder="请输入过滤工艺描述" contenteditable="true" lenlimit="400"></div>
						</div>
					</div>
				</li>
				<li class="data-row" ng-show="ISJJComp">
					<label>现场问题描述</label>
					<div class="body">
						<div class="edit">
							<div ng-model-div-text="ProblemDes" class="needsclick" placeholder="请输入现场问题描述" contenteditable="true" lenlimit="400"></div>
						</div>
					</div>
				</li>
				<li class="data-row" ng-show="ISJJComp">
					<label>工作结果</label>
					<div class="body">
						<div class="edit">
							<div ng-model-div-text="WorkResult" class="needsclick" placeholder="请输入工作结果" contenteditable="true" lenlimit="400"></div>
						</div>
					</div>
				</li>
				<li class="data-row" ng-show="ISJJComp">
					<label>客户意见及建议</label>
					<div class="body">
						<div class="edit">
							<div ng-model-div-text="CustSuggest" class="needsclick" placeholder="请输入客户意见及建议" contenteditable="true" lenlimit="200"></div>
						</div>
					</div>
				</li>
				<li class="data-row" ng-if="audio.FileSize&&audio.FileSize!=0">
					<label>语音描述</label>
					<div class="body">
						<md-audio audio="audio"></md-audio>
					</div>
				</li>
				<li class="data-row" ng-if="imageList.length!=0">
					<label>现场照片</label>
					<div class="body attach">
						<md-image style="display: inline;float: left;" images="imageList" readonly="false"></md-image>
					</div>
				</li>
				<li class="data-row" ng-if="videoList.length!=0">
					<label>现场视频</label>
					<div class="body attach">
						<md-video style="display: inline;float: left;" videos="videoList" readonly="false"></md-video>
					</div>
				</li>
				<li class=" mui-table-view-cell data-row must" ng-click="tap('selectDebugUsers')">
					<label>调试人员</label>
					<i class="opt md-icon icon-right" id="repair-personnel"></i>
					<div class="body">
						<span class="placeholder" ng-if="debugUsers.length==0">请选择调试人员</span>
						<span ng-if="debugUsers.length>0" ng-repeat="user in debugUsers" ng-bind="$index==0?user.ViewName:'，'+user.ViewName"></span>
					</div>
				</li>
			</ul>
			<ul class="data-group" ng-if="!ISJJComp">
				<li class="data-row">
					<label>调试模版</label>
					<p class="opt select-opt" ng-if="!debuggingId">
						<md-custom-select data-options="typeSelectOptions"></md-custom-select>
					</p>
					<div class="body">
						<span ng-bind="TypeObj.ID>0?TypeObj.Name:'默认模板'" ng-style="{color:TypeObj.ID?'':'#dddddd'}"></span>
					</div>
				</li>
			</ul>
			<ul class="data-group" ng-if="ISJJComp">
				<li class="data-row must">
					<label>调试模版</label>
					<p class="opt select-opt" ng-if="!debuggingId">
						<md-custom-select data-options="typeSelectOptions"></md-custom-select>
					</p>
					<div class="body">
						<span ng-bind="TypeObj.Name" ng-style="{color:TypeObj.ID?'':'#dddddd'}"></span>
					</div>
				</li>
			</ul>
			<!--<ul ng-if="ProdList.length>0" class="mui-table-view mui-table-view-chevron" style="margin-top: 8px;">
				<li class="mui-table-view-cell mui-media" ng-click="scan('prodList')">
					<div ng-click="">
						<img src="../../images/imgPre.png" ng-src="{{ProdList[0] | getProdLogo:0:150}}" class="imgslist" ng-style="{'object-fit':pictureStyle==2?'cover':'contain','min-height':pictureStyle==2?'110%':'100%'}" />
						<div class="mui-clearfix" style="margin-right: 30px;">
							<div class="mui-ellipsis equ-title" ng-bind="ProdList[0].ProdName"></div>
							<p class="mui-ellipsis equ-sub" ng-bind="'型号：'+ProdList[0].SkuName"></p>
							<p class="mui-ellipsis equ-sub" ng-bind="'编号：'+ProdList[0].InnerCode"></p>
						</div>
					</div>
					<span ng-if="ProdList.length>1" class="opt color-red-md" ng-bind="'x'+ ProdList.length +ProdList[0].Unit"></span>
				</li>
			</ul>-->
			<div id="params-body">
				<ul class="data-group" ng-repeat="groupParams in debugParams" ng-if="debugParams.length>0" style="margin-top:8px">
					<p class="data-group-tip" ng-bind="groupParams[0].ParamName" ng-if="groupParams[0].IsGroup==1&&groupParams[1]"></p>
					<li class="data-row" ng-repeat="param in groupParams" ng-switch="param.FieldType" ng-class="{'must':param.IsMust==1}" ng-click="paramsTap(param)" ng-if="param.IsGroup==0">
						<label ng-bind="param.ParamName"></label>
						<p class="opt md-icon icon-right" ng-if="param.ParamOptions.length>0"></p>
						<div class="body" ng-switch-when="2|3|19" ng-switch-when-separator="|">
							<span ng-if="!param.ParamDefault&&param.ParamOptions.length>0" class="placeholder" ng-bind="'请选择' + param.ParamName"></span>
							<span ng-if="param.ParamOptions.length>0" ng-bind="param.ParamDefault" data-ParamName="{{param.ParamName}}" data-FiledName="{{param.FiledName}}" data-FieldType="{{param.FieldType}}" data-ParamOptions="true"></span>
							<div class="edit" ng-if="param.ParamOptions.length==0">
								<div lenlimit="200" class="needsclick" ng-bind="param.ParamDefault" placeholder="请输入{{param.ParamName}}" contenteditable="true" data-ParamName="{{param.ParamName}}" data-FiledName="{{param.FiledName}}" data-FieldType="{{param.FieldType}}"></div>
							</div>
						</div>
						<!--datePicker-->
						<p class="opt md-icon icon-right" ng-if="param.FieldType==7"></p>
						<div class="body" data-options='{}' ng-switch-when="7">
							<span ng-if="!param.ParamDefault" class="placeholder" data-FiledName="{{param.FiledName}}" data-FieldType="{{param.FieldType}}">请选择日期</span>
							<span ng-if="param.ParamDefault" ng-bind="param.ParamDefault" data-FiledName="{{param.FiledName}}" data-FieldType="{{param.FieldType}}"></span>
						</div>
					</li>
				</ul>
			</div>

			<ul class="data-group">
				<p class="data-group-tip">相关客户</p>
				<!--<li class="data-row must relevant-customer">
					<label>客户</label>
					<p class="opt md-icon font-15" ng-click="tap('selectCustomer')">
						<span class="icon-right"></span>
					</p>
					<div class="body" ng-click="tap('selectCustomer')">
						<span class="placeholder" ng-show="!customer.ID">请选择客户</span>
						<span ng-show="customer.ID" ng-bind="customer.CustomerName"></span>
					</div>
				</li>-->
				<li class="data-row must relevant-customer">
					<label>客户</label>
					<p class="opt select-opt">
						<md-custom-select data-options="customSelectOptions.select"></md-custom-select>
					</p>
					<div class="body">
						<md-drop-down-list ng-model="customer" data-back="customSelectOptions.dropDownCallback" data-options="{url:customerurl,labname:'请输入或选择客户',type:'debug'}"></md-drop-down-list>
					</div>
				</li>
				<!-- <li class="data-row" ng-click="tap('creatNewCustomer')" style="min-height: auto;"> -->
				<!-- <div class="button"> -->
				<!-- 新建客户 -->
				<!-- </div> -->
				<!-- </li> -->
				<li class="data-row must">
					<label>联系人</label>
					<div class="body">
						<div class="edit">
							<div ng-model-div-text="linkName" class="needsclick" placeholder="请输入联系人" contenteditable="true" lenlimit="20"></div>
						</div>
					</div>
				</li>
				<li class="data-row must">
					<label>联系电话</label>
					<div class="body">
						<div class="edit">
							<div ng-model-div-text="linkPhone" class="needsclick" placeholder="请输入联系电话" contenteditable="true" lenlimit="15"></div>
						</div>
					</div>
				</li>
			</ul>
			<ul class="data-group">
				<li class="mui-table-view-cell data-row">
					<label>抄送给</label>
					<p class="opt md-icon font-15" ng-click="tap('selectUser')">
						<span class="icon-right"></span>
					</p>
					<div class="body" ng-click="tap('selectUser')">
						<span class="placeholder" ng-show="sendUsers.length==0">请选择抄送人</span>
						<span ng-show="sendUsers.length>0" ng-repeat="user in sendUsers" ng-bind="$index==0?user.ViewName:'，'+user.ViewName"></span>
					</div>
				</li>
			</ul>
			<ul class="data-group">
				<li class="mui-table-view-cell data-row">
					<i class="opt md-icon icon-position" style="color: #3296FA;"></i>
					<label>调试地点</label>
					<div class="body">
						<span ng-bind="customer.Province | locationfilter:customer.City:customer.District:customer.Address:customer.Street"></span>
					</div>
				</li>
			</ul>
			<div class="mui-content-padded">
				<span class="mui-btn mui-btn-block" ng-click="save()">保存</span>
				<span class="mui-btn mui-btn-block" ng-click="save('print')" ng-if="ISJJComp">保存并下载工单</span>
				<span class="mui-btn mui-btn-block mui-btn-block-white" ng-click="saveDrafts()">保存到草稿箱</span>
			</div>
			<div class="mui-content-padded">

			</div>
		</div>
		<!--无网络或请求失败重试-->
		<md-state-tip options="retryModal" ng-show="retryModal.state"></md-state-tip>
		<footer class="footBtn" style="display: none;" id="footer">
			<md-record-media videos="videoList" audio="audio" images="imageList" callback="getMediaRes"></md-record-media>
		</footer>
		<script type="text/javascript" src="../../js/mui.min.js"></script>
		<script type="text/javascript" src="../../js/angular.min.js"></script>
		<script type="text/javascript" src="../../js/common.js"></script>
		<script type="text/javascript" src="../../js/utils.js"></script>
		<script type="text/javascript" src="../../js/rpc.js"></script>
		<script type="text/javascript" src="../message/transMessage.js"></script>
		<script src="../../js/jSignature/libs/jquery.js"></script>
		<script src="../../js/jSignature/src/jSignature.js"></script>
		<script type="text/javascript">
			app.controller("DebugEditController", ["$scope", "UtilsService", "$Modal", "DataService", "ApiService",
				"DatePickerService", "Loading", "$q", "ChatUserService", "$filter", "$timeout", "BillService", "RPCObserver",
				"AuthService", "CacheService",
				function($scope, UtilsService, $Modal, DataService, ApiService, DatePickerService, Loading, $q, ChatUserService,
					$filter, $timeout, BillService, RPCObserver, AuthService, CacheService) {
					$scope.title = query("title") || "安装调试记录";
					$scope.ItemID = query('id');
					$scope.draftId = query('draftId');
					$scope.print = false; //打印
					$scope.IsNew = query("id") ? false : true; //判断是否是新建单，只有新建才有客户签名
					var curDate = new Date().Format("yyyy-MM-dd HH-mm-ss");

					$scope.process = {
						SaveState: 0, //0未保存 1保存成功 2保存中 3保存失败
						ProcessList: [{
							Text: "上传语音文件", //0未执行 1执行中 2完成 3失败
							State: 0,
							RetryMethod: uploadAudio
						}, {
							Text: "上传图片",
							State: 0,
							RetryMethod: uploadImgs
						}, {
							Text: "上传视频",
							State: 0,
							RetryMethod: uploadVideos
						}, {
							Text: "保存安装调试内容",
							State: 0,
							RetryMethod: submitData
						}, {
							Text: "通知抄送人",
							State: 0,
							RetryMethod: sendMsg
						}]
					};
					var mui_back = mui.back;
					mui.back = function() {
						if(document.getElementById("signatureparent").style.display == "block") {
							$scope.signature("close");
							return;
						}
						mui_back()
					}
					var curUser = CacheService.get("user");

					$scope.TypeObj = {
						ID: query("typeid") || -1,
						Name: query("title") || ""
					};
					$scope.JobContent = "";
					$scope.linkName = "";
					$scope.linkPhone = "";
					//景津定制字段
					$scope.FilterPlateType = ""; //滤板类型
					$scope.FilterClothType = ""; //滤布型号
					$scope.FilterTechDes = ""; /// 过滤工艺描述
					$scope.ProblemDes = ""; /// 现场问题描述
					$scope.WorkResult = ""; //工作结果
					$scope.CustSuggest = ""; /// 客户意见建议
					$scope.Quantity = 1;
					$scope.ISJJComp = curUser.CompID == 266;
//                  function searech(){
//                  	alert(111)
//                  }
					//无网络或请求失败重试
					$scope.retryModal = {
						msg: "安装调试",
						retry: init,
						state: ''
					}

					var postData = {
						ImgAttach: null,
						ArmAttach: null,
						VideoAttach: null
					}
					$scope.audio = {}; //上传音频
					$scope.videoList = []; //上传视频
					$scope.imageList = []; //上传图片
					$scope.needCheck = true; //是否验证同一种产品
					//产品
					$scope.ProdList = [];
					$scope.prodInfo = {
						ProdID: 0,
						ProdName: "",
						SkuID: 0,
						SkuName: "",
						InnerCode: "",
						MDCode: "",
					};
					$scope.EqJane="";
					// if (!$scope.ItemID > 0) {
					// 	var cur_view = plus.webview.currentWebview();
					// 	var prodinfo = cur_view.obj;
					// 	if (prodinfo.ProdInnerCode) {
					// 		prodinfo.InnerCode = prodinfo.ProdInnerCode;
					// 	} else {
					// 		if (!prodinfo.InnerCode) {
					// 			prodinfo.InnerCode = ''
					// 		}
					// 	}
					// 	$scope.ProdList.push(prodinfo);
					// 	$scope.prodInfo = {
					// 		ProdID: prodinfo.ProdID,
					// 		ProdName: decodeURIComponent(prodinfo.ProdName),
					// 		SkuID: prodinfo.SkuID,
					// 		SkuName: decodeURIComponent(prodinfo.SkuName),
					// 		InnerCode: decodeURIComponent(prodinfo.InnerCode),
					// 		MDCode: prodinfo.MDCode
					// 	};
					// }
					//客户
					$scope.customer = {
						ID: 0,
						Name: "",
						Province: "",
						City: "",
						District: "",
						Address: "",
						Street: "",
						MapLng: "",
						MapLat: ""
					};
					//抄送人
					$scope.sendUsers = [];
					//调试人员
					$scope.debugUsers = [];

					var sendUserIDs = [];

					$scope.typeSelectOptions = {
						model: $scope.TypeObj,
						idField: "ID",
						nameField: "Name",
						selectfn: function() {
							$scope.tap("type");
						},
						clearfn: function() {
							$scope.TypeObj = {
								ID: -1,
								Name: ""
							};
							getDebugParamsList();
						}
					};

					//安装调试参数
					$scope.debugParams = [];

					$scope.customSelectOptions = {
						select: {
							model: $scope.customer,
							idField: 'ID',
							nameField: 'Name',
							selectfn: function() {
								$scope.tap('selectCustomer');
							},
							clearfn: function() {
								$scope.linkName = "";
								$scope.linkPhone = "";

								var names = Object.getOwnPropertyNames($scope.customer);
								for(var i = 0; i < names.length; i++) {
									$scope.customer[names[i]] = names[i] == "ID" ? 0 : "";
								}
							}
						},
						dropDownCallback: function(data) {
							if(data.LinkManList.length > 0) {
								$scope.linkName = data.LinkManList[0].LinkName || "";
								$scope.linkPhone = data.LinkManList[0].LinkPhone || "";
							}
						}

					}
					//参数类型id
					$scope.paramTypeID = query("typeid") || -1;
					//安装调试id
					$scope.debuggingId = query("id") || 0;
					$scope.customerurl = ApiService.Api50 + "/api/v2/Customer/SearchCustomer?keyWords=";

					//监听-停止语音
					$scope.$on('emit-stop-audio', function() {
						$scope.$broadcast("stop_audio");
					});

					AuthService.getAuth().then(function(res) {
						$scope.InnerCodeName = res.InnerCodeName || '出厂编号';
						if($scope.debuggingId == 0 && $scope.debugUsers.length == 0) {
							$scope.debugUsers.push({
								"UserID": curUser.UserID,
								"ViewName": $filter("getViewName")(curUser.UserName, curUser.RealName, curUser.Mdt),
								"CompID": curUser.CompID,
								"ULogoIsExist": curUser.ULogoIsExist
							})
							UtilsService.getDefaultRecipient().then(function(res) {

								res && $scope.sendUsers.length == 0 && $scope.sendUsers.push({
									"UserID": res.UserID,
									"ViewName": res.ViewName,
									"CompID": res.CompID,
									"ULogoIsExist": res.ULogoIsExist
								})
							});
						}
					});

					function init() {

						if($scope.draftId) {
							$scope.renderDrafts();
						} else {

							Loading.show();
							if($scope.debuggingId && $scope.debuggingId > 0) {
								getProdDebugInfo();
							} else {
								//获取安装调试参数
								getDebugParamsList();
								//接收产品信息
								var ws = plus.webview.currentWebview();
								var prodInfo = ws.prodInfo;
								$scope.isscan = ws.isscan;
								if(prodInfo != undefined) {
									//ProdID ProdName SkuID SkuName ProdInnerCode MDCode
									$scope.ProdList[0] = {
										ProdID: prodInfo.ProdID,
										ProdName: prodInfo.ProdName,
										SkuID: prodInfo.SkuID,
										SkuName: prodInfo.SkuName,
										InnerCode: prodInfo.ProdInnerCode || prodInfo.InnerCode,
										MDCode: prodInfo.MDCode,
									}
									$scope.prodInfo = $scope.ProdList[0];
									$scope.EqJane=prodInfo.EqJane;
								}
								//位置定位
								UtilsService.getLocation(true).then(function(location) {
									$scope.customer.MapLat = location.lat; //纬度
									$scope.customer.MapLng = location.lng; //经度
									$scope.customer.Address = location.address; //详细地址
									$scope.customer.Province = location.province; //省
									$scope.customer.City = location.city; //市
									$scope.customer.District = location.district; //区
									$scope.customer.Street = location.street; //街道
								});
								}
								}
								};
								
								$scope.getcuinfo = function() {
									if($scope.ISJJComp){
										if(document.getElementById("prodInnerCode").innerText.trim() == "") {
										return;
									}else {
										var url = ApiService.Api50 + "/api/v1/MdCode/GetMdCodeByInnerCode?CompID=" + curUser.CompID + '&InnerCode=' + document.getElementById("prodInnerCode").innerText;
										DataService.get(url).then(function(res) {
											$scope.prodInfo.ProdName=res.ProdName
											$scope.prodInfo.ProdID=res.ProdID
											$scope.prodInfo.SkuName = res.SkuName
											$scope.ProdList[0]=res
											
										}, function(e) {
										})
									}
									}
									
								}
					//获取安装调试参数
					function getDebugParamsList() {
						var url = ApiService.Api50 + "/api/v1/ProdDebug/GetDebugParamsList?typeId=" + $scope.TypeObj.ID;
						DataService.get(url).then(function(res) {

							//清空 选择 类型字段中不存在于备选值的默认值
							res.forEach(function(item, index) {
								if(item.ParamOptions.length > 0) {
									var paramOptions = item.ParamOptions.split("\r\n");
									paramOptions.indexOf(item.ParamDefault) <= -1 && (item.ParamDefault = "");
								}
							})
							Loading.hide();
							//$scope.isLoad = true;
							document.getElementById("content").style.display = "block";
							document.getElementById("footer").style.display = "block";
							$scope.debugParams = [];
							$scope.retryModal.state = '';
							if(res) {
								res.forEach(function(item, index) {
									if(item.IsGroup) {
										$scope.debugParams.push([item]);
									} else {
										index == 0 && $scope.debugParams.push([]);
										$scope.debugParams.slice(-1)[0].push(item);
									}
								})
							}
						}, function(error) {
							$scope.retryModal.state = error.State;
						})
					}

					$scope.paramsTap = function(item) {
						$scope.$broadcast("stop_audio");
						//actionsheet
						if(item.ParamOptions.length > 0) {
							var buttons = [];
							var paramOptions = item.ParamOptions.split("\r\n");
							paramOptions.forEach(function(item) {
								item.trim() && buttons.push({
									title: item
								})
							})
							UtilsService.actionSheet("", buttons).then(function(res) {
								item.ParamDefault = res.title;
							})
							return;
						}
						switch(item.FieldType) {
							case 7:
								DatePickerService.pickDate({
									selected: item.ParamDefault,
								}).then(function(res) {
									item.ParamDefault = res;
								});
								break;
						}
					}
					$scope.tap = function(key) {
						$scope.$broadcast("stop_audio");
						switch(key) {
							//选择抄送人
							case 'selectUser':
								UtilsService.openWindow({
									needLogin: true,
									id: "contact-select.html",
									url: "../common/contact-select.html?action=select&multiselect=true&type=org",
									extras: {
										selectObj: $scope.sendUsers,
										callback: "selectUserCallback"
									}
								});
								break;
								//选择调试人员
							case 'selectDebugUsers':
								UtilsService.openWindow({
									needLogin: true,
									id: "contact-select.html",
									url: "../common/contact-select.html?action=select&multiselect=true&must=true&type=org",
									extras: {
										selectObj: $scope.debugUsers,
										callback: "selectDenugUserCallback"
									}
								});
								break;
								//选择客户
							case 'selectCustomer':
								UtilsService.openWindow({
									needLogin: true,
									id: "customer-search.html",
									url: "../search/customer-search.html?action=select&must=true",
									extras: {
										selectObj: $scope.customer,
										callback: "selectCustomerContactCallback"
									}
								});
								break;
							case "type":
								UtilsService.openWindow({
									needLogin: true,
									id: "debug-model-list.html",
									url: "debug-model-list.html",
									extras: {
										selectObj: {
											id: $scope.TypeObj.ID,
											name: $scope.TypeObj.Name
										},
										callback: "selectTypeCallback"
									}
								});
								break;

						}
					};

					$scope.renderDrafts = function() {
						var cache = CacheService.get(curUser.UserID + "_mat_debug_submit") || {};
						var data = cache[$scope.draftId];
//						console.log(JSON.stringify(data))
						if(data) {
							Object.keys(data.content).forEach(function(item) {
								if(item == "prodInnerCode") {
									document.getElementById("prodInnerCode").innerText = data.content[item];
								} else if(item == "debugParaValues") {

								} else if(item == "id") {

								} else {
									$scope[item] = data.content[item];
								}
							});
						}

						setTimeout(function() {
							var paramsDom = document.querySelectorAll("[data-FiledName]");
							for(var i = 0; i < paramsDom.length; i++) {
								var ele = paramsDom[i];
								var FiledName = ele.getAttribute("data-FiledName");
								ele.innerHTML = data.content["debugParaValues"][i];
							}
						}, 100);
						//$scope.isLoad = true;
						document.getElementById("content").style.display = "block";
						document.getElementById("footer").style.display = "block";

					};

					$scope.saveDrafts = function() {

						var cache = CacheService.get(curUser.UserID + "_mat_debug_submit") || {};
						var curDate = new Date();

						var debugValues = {};
						var paramsDom = document.querySelectorAll("[data-FiledName]");
						for(var i = 0; i < paramsDom.length; i++) {
							var ele = paramsDom[i];
							var FiledName = ele.getAttribute("data-FiledName");
							var FieldType = ele.getAttribute("data-FieldType");
							var value = replaceHTML(ele.innerText);
							(FieldType == 7 && value == "请选择日期") && (value = "");
							debugValues[i] = value;
						}

						var data = {
							id: curDate.getTime(),
							createdate: curDate.Format("yyyy-MM-dd HH:mm:ss"),
							content: {
								audio: $scope.audio,
								imageList: $scope.imageList,
								videoList: $scope.videoList,
								customer: $scope.customer,
								JobContent: $scope.JobContent,
								FilterTechDes: $scope.FilterTechDes,
								FilterPlateType: $scope.FilterPlateType,
								FilterClothType: $scope.FilterClothType,
								ProblemDes: $scope.ProblemDes,
								WorkResult: $scope.WorkResult,
								CustSuggest: $scope.CustSuggest,
								TypeObj: $scope.TypeObj,
								debugUsers: $scope.debugUsers,
								ProdList: $scope.ProdList,
								linkName: $scope.linkName,
								prodInfo: $scope.prodInfo,
								linkPhone: $scope.linkPhone,
								Quantity: $scope.Quantity,
								prodInnerCode: document.getElementById("prodInnerCode").innerText.trim(),
								debuggingId: $scope.debuggingId,
								sendUsers: $scope.sendUsers,
								debugParams: $scope.debugParams,
								debugParaValues: debugValues,
								EqJane:$scope.EqJane
							}
						};

						if($scope.draftId) {
							delete cache[$scope.draftId];
						}

						cache[data.id] = data;
						$scope.draftId = data.id;

						$scope.saveToCache(cache);
						mui.toast("已保存到草稿箱")
					};

					$scope.delteDrafts = function() {
						if($scope.draftId) {
							var cache = CacheService.get(curUser.UserID + "_mat_debug_submit") || {};

							delete cache[$scope.draftId];
							$scope.saveToCache(cache);
						}
					};

					function rpcDrafts() {
						RpcClient.invoke("mat-drafts-prod-tx.html", "Rpc_refDrafts");
					};

					$scope.saveToCache = function(data) {
						CacheService.set(curUser.UserID + "_mat_debug_submit", data, true);
						rpcDrafts();
					}

					window.selectTypeCallback = function(obj) {

						if(obj) {
							$scope.TypeObj.ID = obj.ID;
							$scope.TypeObj.Name = obj.Name;
							$scope.typeSelectOptions.model.ID = obj.ID;
							$scope.typeSelectOptions.Name = obj.Name;
							getDebugParamsList();
						} else {
							$scope.TypeObj = {
								ID: -1,
								Name: ""
							};
							getDebugParamsList();
						}
						$scope.$apply();
					};

					//根据id获取设备故障工单信息
					function getProdDebugInfo() {
						var url = ApiService.Api50 + "/api/v1/ProdDebug/GetProdDebugInfo?prodDebugId=" + $scope.debuggingId;
						DataService.get(url).then(function(res) {

							Loading.hide();
							//$scope.isLoad = true;
							document.getElementById("content").style.display = "block";
							document.getElementById("footer").style.display = "block";
							$scope.retryModal.state = '';
							if(res) {
								//获取调试设备的信息
								getProdInfoByMdCode(res.MdCode, res.InnerCode);
								postData.ID = $scope.debuggingId || "";
								$scope.TypeObj.ID = res.ParamTypeID || -1;
								$scope.TypeObj.Name = res.ParamTypeName;
								$scope.JobContent = res.JobContent;
								$scope.FilterTechDes = res.FilterTechDes;
								$scope.FilterPlateType = res.FilterPlateType;
								$scope.FilterClothType = res.FilterClothType;
								$scope.ProblemDes = res.ProblemDes;
								$scope.WorkResult = res.WorkResult;
								$scope.CustSuggest = res.CustSuggest;
								$scope.ProdList = [{
									ProdID: res.ProdID,
									ProdName: res.ProdName,
									MDCode: res.MdCode,
									SkuName: res.SkuName,
									SkuID: res.SkuID,
									InnerCode: res.InnerCode,
									IsNew: res.IsNew
								}];
								$scope.EqJane=res.EqJane;
								$scope.debugParams = [];
								res.DebugParams.forEach(function(item) {
									if(item.IsGroup == 1) {
										$scope.debugParams.push([]);
									}
									var len = $scope.debugParams.length;
									len == 0 && $scope.debugParams.push([item]);
									len > 0 && $scope.debugParams[len - 1].push(item);
								})

								$scope.customer.ID = res.CustomerID;
								$scope.customer.Name = res.CustomerName;
								$scope.customer.Province = res.Province;
								$scope.customer.City = res.City;
								$scope.customer.District = res.District;
								$scope.customer.Address = res.Address;
								$scope.customer.Street = res.Street;
								$scope.customer.MapLng = res.MapLng;
								$scope.customer.MapLat = res.MapLat;
								$scope.linkName = res.LinkName;
								$scope.linkPhone = res.LinkPhone;
								$scope.Quantity = res.Quantity;

								//抄送人
								$scope.sendUsers = [];
								res.Users.forEach(function(user) {
									$scope.sendUsers.push({
										"UserID": user.ID,
										"ViewName": user.Name,
										"CompID": user.CompID,
										"ULogoIsExist": user.ULogoIsExist
									})
								});
								sendUserIDs = [];
								sendUserIDs = res.Users.map(function(user) {
									return user.ID
								});
								//调试人
								$scope.debugUsers = [];
								res.DebugUsers.forEach(function(user) {
									$scope.debugUsers.push({
										"UserID": user.ID,
										"ViewName": user.Name,
										"CompID": user.CompID,
										"ULogoIsExist": user.ULogoIsExist
									})
								});

								//语音
								$scope.audio = res.ArmAttach || {};
								//照片
								res.ImgAttach.forEach(function(item) {
									item.State = 1;
								});
								$scope.imageList = res.ImgAttach;

								//视频
								res.VideoAttach.forEach(function(item) {
									item.State = 1;
								});
								$scope.videoList = res.VideoAttach;

							}
						}, function(error) {
							$scope.retryModal.state = error.State;
						})
					};

					//获取产品详情
					function getProdInfoByMdCode(mdcode, innercode) {
						var url = ApiService.Api50 + "/api/v1/MdCode/GetProdInfoByMdCode?code=" + mdcode;
						DataService.get(url).then(function(reData) {
							$scope.prodInfo = {
								ProdID: reData.ProdID,
								ProdName: reData.ProdName,
								SkuID: reData.SkuID,
								SkuName: reData.SkuName,
								InnerCode: reData.InnerCode,
								MDCode: mdcode,
							};
							$scope.EqJane=reData.EqJane;
							if(!($scope.prodInfo.MDCode && $scope.prodInfo.InnerCode)) {
								document.getElementById("prodInnerCode").innerText = innercode;
							}
						});
					}

					//跳转产品详情
					$scope.toProdInfoPage = function(id) {
						if($scope.isscan) {
							UtilsService.openWindow({
								needLogin: true,
								id: 'prodinfo-head.html',
								url: '../problib/prodinfo-head.html?prodId=' + id
							});
						}
					};

					$scope.scan = function(key) {
						document.activeElement.blur();
						$scope.$broadcast("stop_audio");
						setTimeout(function() {
							UtilsService.openWindow({
								needLogin: true,
								id: 'scan.html',
								url: '../scan/scan.html',
								extras: {
									callback: "scanCallback"
								}
							});
						})
					};

					//初始化
					init();

					//避免重复点击
					var isSubmitting = false;

					//保存
					$scope.save = function(key) {
						$scope.print = key && key == 'print' ? true : false;
						$scope.$broadcast("stop_audio");
						document.activeElement.blur();
						//验证填字符长度
						if(!checkLengthUtil.check()) {
							return false;
						}
						if($scope.JobContent.trim() == "") {
							mui.toast("请输入工作内容");
							return;
						}
						if($scope.debugUsers.length == 0) {
							mui.toast("请选择调试人员");
							return;
						}
						if($scope.ProdList.length == 0) {
							mui.toast("请扫描迈迪国标物联码");
							return;
						}
						if($scope.ISJJComp && ($scope.TypeObj.ID == -1 || $scope.TypeObj.ID == "")) {
							mui.toast("请选择调试模板");
							return;
						}
						if(!($scope.ProdList[0].MDCode && $scope.ProdList[0].InnerCode) && document.getElementById("prodInnerCode").innerText
							.trim() == "") {
							mui.toast("请输入" + $scope.InnerCodeName);
							return;
						}
						//验证必填参数
						if(!verify()) return;
						if(!$scope.customer.Name) {
							mui.toast("请输入或选择一个客户！");
							return;
						}
						if($scope.linkName.trim() == "") {
							mui.toast("请输入联系人！");
							return;
						}
						if($scope.linkPhone.trim() == "") {
							mui.toast("请输入联系电话！");
							return;
						}

						//验证数字和日期
						if(!isNumberOrDate()) return;

						//验证填字符长度
						if(!checkLengthUtil.check()) {
							return false;
						}

						if(isSubmitting) return;
						//开始上传
						isSubmitting = true;
						//如果保存后打印
						$scope.print && $scope.process.ProcessList.push({
							Text: "打印工单",
							State: 0,
							RetryMethod: printOrder
						})
						if(postData.ImgAttach == null) {
							postData.ImgAttach = $scope.imageList.filter(function(item) {
								return item.ID > 0;
							}).map(function(item) {
								return {
									ID: item.ID,
									FileGuid: item.FileGuid,
									FileName: item.FileName,
									FileExt: item.FileExt,
									FilePath: item.FilePath,
									FileSize: item.FileSize,
									FileType: item.FileType
								}
							})
						}
						if(postData.VideoAttach == null) {
							postData.VideoAttach = $scope.videoList.filter(function(item) {
								return item.ID > 0;
							}).map(function(item) {
								return {
									ID: item.ID,
									FileGuid: item.FileGuid,
									FileName: item.FileName,
									FileExt: item.FileExt,
									FilePath: item.FilePath,
									FileSize: item.FileSize,
									FileType: item.FileType
								}
							})
						}
						UtilsService.submitModal($scope.process, function() {
							isSubmitting = false;
							mui.back();
						}, function() {
							isSubmitting = false;
							postData.ImgAttach = null;
							postData.VideoAttach = null;
							$scope.process.SaveState = 0;
							$scope.process.ProcessList.forEach(function(item) {
								item.State = 0;
							})
							$scope.process.ProcessList[5] && $scope.process.ProcessList.splice(5, 1);
							getProdDebugInfo();
						}, function() {
							isSubmitting = false;
							$scope.process.ProcessList.forEach(function(item) {
								item.State = 0;
							})
							postData.ImgAttach = [];
							$scope.imageList.forEach(function(item) {
								item.State = 0;
							})
							postData.VideoAttach = [];
							$scope.videoList.forEach(function(item) {
								item.State = 0;
							})
						});
						//开始附件上传(语音-图片-视频)
						uploadAudio();
					};

					//上传语音
					function uploadAudio() {
						if($scope.audio && $scope.audio.FileSize && !$scope.audio.FileGuid) {
							$scope.process.ProcessList[0].State = 1;
							UtilsService.uploadFileBill($scope.audio.FilePath, 2).then(function(res) {
								if(res != null) {
									res.FileSize = $scope.audio.FileSize;
									res.FileType = 2;
									postData.ArmAttach = res;
								}
								$scope.process.ProcessList[0].State = (res == null ? 3 : 2);
								//上传图片
								uploadImgs();
							});
						} else {
							if($scope.audio.FileGuid) {
								postData.ArmAttach = $scope.audio;
							}
							$scope.process.ProcessList[0].State = 2;
							//上传图片
							uploadImgs();
						}
					}
					//上传图片
					function uploadImgs() {
						if([0, 3].indexOf($scope.process.ProcessList[1].State) >= 0) {
							$scope.process.ProcessList[1].State = 1;
							var imgs = $scope.imageList.filter(function(img) {
								return img.State == 0;
							});
							if(imgs.length > 0) {
								var promises = imgs.map(function(img) {
									return UtilsService.uploadFileBill(img.FilePath, 1);
								});
								$q.all(promises).then(function(res) {
									var flag = true;
									res.forEach(function(img, index) {
										if(img == null) {
											flag = false;
										} else {
											imgs[index].State = 1;
											img.FileSize = imgs[index].FileSize;
											img.FileType = 1;
											postData.ImgAttach.push(img);
										}
									});
									$scope.process.ProcessList[1].State = flag ? 2 : 3;
									//上传视频
									uploadVideos();
								});
							} else {
								$scope.process.ProcessList[1].State = 2;
								//上传视频
								uploadVideos();
							}
						} else {
							uploadVideos();
						}
					}
					//上传视频
					function uploadVideos() {
						if([0, 3].indexOf($scope.process.ProcessList[2].State) >= 0) {
							$scope.process.ProcessList[2].State = 1;
							var videos = $scope.videoList.filter(function(video) {
								return video.State == 0;
							});
							if(videos.length > 0) {
								var promises = videos.map(function(video) {
									return UtilsService.uploadFileBill(video.FilePath, 3);
								});
								$q.all(promises).then(function(res) {
									var flag = true;
									res.forEach(function(video, index) {
										if(video == null) {
											flag = false;
										} else {
											videos[index].State = 1;
											video.FileSize = videos[index].FileSize;
											video.FileType = 3;
											postData.VideoAttach.push(video);
										}
									});
									$scope.process.ProcessList[2].State = flag ? 2 : 3;
									//提交
									submitData();
								});
							} else {
								$scope.process.ProcessList[2].State = 2;
								//提交
								submitData();
							}
						} else {
							submitData();
						}
					}
					//上传安装调试详情
					function submitData() {
						if($scope.process.ProcessList[0].State == 2 && $scope.process.ProcessList[1].State == 2 && $scope.process.ProcessList[2].State == 2) {
							$scope.process.ProcessList[3].State = 1;
							postData.ID = $scope.debuggingId || 0;
							postData.JobContent = $scope.JobContent;
							postData.FilterTechDes = $scope.FilterTechDes;
							postData.FilterPlateType = $scope.FilterPlateType;
							postData.FilterClothType = $scope.FilterClothType;
							postData.ProblemDes = $scope.ProblemDes;
							postData.WorkResult = $scope.WorkResult;
							postData.CustSuggest = $scope.CustSuggest;
							postData.CustomerName = $scope.customer.Name;
							postData.EqJane=$scope.EqJane;
							postData.CustomerID = 0;
							postData.Province = $scope.customer.Province;
							postData.City = $scope.customer.City;
							postData.District = $scope.customer.District;
							postData.Address = $scope.customer.Address;
							postData.Street = $scope.customer.Street;
							postData.MapLat = $scope.customer.MapLat;
							postData.MapLng = $scope.customer.MapLng;
							postData.LinkName = $scope.linkName;
							postData.LinkPhone = $scope.linkPhone;
							postData.Quantity = $scope.Quantity > 0 ? $scope.Quantity : 1;
							postData.SendUsers = $scope.sendUsers.map(function(item) {
								return item.UserID;
							}).join('/');
							postData.DebugUsers = $scope.debugUsers.map(function(item) {
								return item.UserID;
							}).join('/');
							postData.ParamTypeID = $scope.TypeObj.ID || -1;
							postData.IsHasAudio = $scope.audio.FileSize > 0 ? 1 : 0;
							postData.AudioLength = $scope.audio.FileSize || 0;

							postData.MdCodeList = [];
							$scope.ProdList.forEach(function(prod) {
								postData.MdCodeList.push({
									MDCode: prod.MDCode,
									InnerCode: $scope.prodInfo.InnerCode ? $scope.prodInfo.InnerCode : document.getElementById(
										"prodInnerCode").innerText,
									ProdID: prod.ProdID,
									SkuName: prod.SkuName,
									SkuID: prod.SkuID
								})
							})

							postData.FieldList = [];
							var paramsDom = document.querySelectorAll("[data-FiledName]");
							for(var i = 0; i < paramsDom.length; i++) {
								var ele = paramsDom[i];
								var FiledName = ele.getAttribute("data-FiledName");
								var FieldType = ele.getAttribute("data-FieldType");
								var value = replaceHTML(ele.innerText);
								(FieldType == 7 && value == "请选择日期") && (value = "");
								postData.FieldList.push({
									"key": FiledName,
									"value": value,
									"FieldType": FieldType
								})
							}
							var url = ApiService.Api50 + "/api/v1/ProdDebug/SaveProdDebug";
							DataService.post(url, postData).then(function(res) {
								if(res) {
									$scope.debuggingId = res[0];
									$scope.delteDrafts();
									$scope.process.ProcessList[3].State = 2;

									if($scope.IsNew && $scope.ISJJComp) {
										$Modal.close();
										$scope.signature("show");
									} else {
										$scope.print && printOrder();
										$timeout(function() {
											$scope.process.SaveState = 1;
										}, 800);
									}
									//rpc通知
									rpc();
									//通知抄送人
									sendMsg(res);
								}
							}, function(res) {
								$scope.process.ProcessList[5] && $scope.process.ProcessList.splice(5, 1);
								$scope.process.ProcessList[3].State = 3;
							});
						}
					}

					//rpc
					function rpc() {
						//刷新客户详情-合计 列表
						RPCObserver.broadcast("refresh_my_sxun");
						RpcClient.invoke("debug-info.html", "RPC_DebugInfoRefresh");
						//刷新 安装调试搜索
						RPCObserver.broadcast('refresh_debug_search_list');
						//刷新 故障列表
						RPCObserver.broadcast('refresh_mat_debug_list');
						// 客户信息刷新
						RpcClient.invoke("customer-info.html", "RPC_BillViewRefresh", "customer");
					}

					//打印安装调试工单
					function printOrder() {
						var debugUsers = $scope.debugUsers.map(function(item) {
							return item.ViewName;
						}).join(',');
						var serverPath = ApiService.Api50 + "/api/v1/MatWorkOrder/ExportInstallExcel?prodDebugId=" + $scope.debuggingId + "&compId=" + curUser.CompID;
						var localPath = "_doc/DebugOrder/" + curUser.CompName + $scope.prodInfo.SkuName + debugUsers + $scope.TypeObj.Name + curDate + ".pdf";
						$scope.process.ProcessList[5].State = 1;
						downloadFile(serverPath, localPath, function(localfile, status) {
							if(status == 200) {
								$scope.process.ProcessList[5].State = 2;
								mui.toast("下载成功");
								plus.io.resolveLocalFileSystemURL(localPath, function(entry) {
									plus.runtime.openFile(localPath, {
										top: 10,
										left: 10,
										width: 200,
										height: 200
									}, function(e) {
										mui.toast("无法打开此文件！");
									});
								}, function() {});
								$scope.process.ProcessList[5] && $scope.process.ProcessList.splice(5, 1);
							} else {
								$scope.process.ProcessList[5].State = 3;
								$scope.process.ProcessList[5] && $scope.process.ProcessList.splice(5, 1);
								mui.toast("下载失败");
							}
						})

					}

					//给抄送人发送消息
					function sendMsg(params) {
						$scope.process.ProcessList[4].State = 2;
						$scope.sendUsers.filter(function(user) {
							return sendUserIDs.indexOf(user.UserID) < 0
						}).forEach(function(user) {
							ChatUserService.send({
								chatId: user.UserID,
								chatName: user.ViewName,
								chatCompId: user.CompID,
								chatLogo: user.ULogoIsExist,
								hasLogo: curUser.ULogoIsExist,
								type: 7,
								content: {
									eventName: "debug",
									logo: ApiService.Down + "/chat/debug.png",
									title: "安装调试",
									desc: $filter("formatFaultInfo")(postData.IsHasAudio, postData.AudioLength, postData.JobContent),
									params: params
								}
							});
						})
					}

					//校验
					function verify() {
						var verify = true;
						var paramsBodys = document.getElementById("params-body");
						for(var j = 0; j < paramsBodys.childNodes.length; j++) {
							var paramsBody = paramsBodys.childNodes[j];
							if(paramsBody && paramsBody.nodeName == "UL") {
								var required = paramsBody.querySelectorAll(".must");
								for(var i = 0; i < required.length; i++) {
									var item = required[i];
									var requiredItems = item.querySelector("div");
									var requiredNode = requiredItems.querySelector("span,div");
									if(requiredNode.nodeName == "DIV") {
										var contenteditableDiv = requiredNode.childNodes[1];
										if(contenteditableDiv.innerText.replace(/(^\s*)|(\s*$)/g, "") == "") {
											mui.toast(contenteditableDiv.getAttribute("placeholder"));
											verify = false;
											break;
										}
									} else if(requiredNode.nodeName == "SPAN") {
										var paramName = replaceHTML(item.childNodes[1].innerText);
										if(requiredNode.innerText == "请选择日期") {
											mui.toast('请选择' + paramName);
											verify = false;
											break;
										}
										if(requiredNode.classList.contains("placeholder") || requiredNode.innerText.trim() == "") {
											mui.toast('请选择' + paramName);
											verify = false;
											break;
										}
									}
								}
							}
							if(!verify) {
								break;
							}
						}

						return verify;
					}

					//校验数字和日期格式
					function isNumberOrDate() {
						var verify = true;
						var reg = /^(-)?([1-9]\d*|0)(\.\d+)?$/;
						var paramsDom = document.querySelectorAll("[data-FiledName]");
						for(var i = 0; i < paramsDom.length; i++) {
							var ele = paramsDom[i];
							var FieldType = ele.getAttribute("data-FieldType");
							if(FieldType == 2 && !reg.test(ele.innerText.trim()) && ele.innerText.trim() != "") {
								ele.focus();
								mui.toast("该项【" + ele.getAttribute("data-ParamName") + "】只能输入正确格式的数字");
								verify = false;
								break;
							} else if(FieldType == 7 && ele.innerText != "请选择日期" && ele.innerText.trim() != "" && !ele.innerText.trim().match(
									/^(\d{1,4})(-|\/)(\d{1,2})\2(\d{1,2})$/)) {
								mui.toast("请选择正确的日期");
								verify = false;
								break;
							}
						}
						return verify;
					}

					//选择客户回调
					window.selectCustomerContactCallback = function(obj) {
						$scope.customer.ID = obj.ID;
						$scope.customer.Name = obj.CustomerName;
						if(obj.LinkManList.length > 0) {
							$scope.linkName = obj.LinkManList[0].LinkName;
							$scope.linkPhone = obj.LinkManList[0].LinkPhone;
						}
						$scope.$apply();
					}

					//电子签名部分：
					//isLoad 改为 document.getElementById("content").style.display = "block";
					$scope.datapair = "";
					var screen_height = window.screen.availWidth - 120;
					var screen_width = window.screen.availHeight;
					var $sigdiv = $("#signature").jSignature({
						"width": screen_width,
						"height": screen_height,
						"lineWidth": 7,
						"background-color": "#FFFFFF"
					})
					pubsubprefix = 'jSignature.demo.'
					//电子签名
					$scope.signature = function(key) {
						switch(key) {
							case "show":
								canvas.show();
								plus.screen.lockOrientation('landscape'); //锁死屏幕方向为横屏
								break;
							case "clear":
								$sigdiv.jSignature('reset');
								break;
							case "save":
								$scope.datapair = $sigdiv.jSignature("getData");
								var signatureData = {
									"dataId": $scope.debuggingId,
									"type": 1,
									"picBase64String": $scope.datapair
								};
								var signUrl = ApiService.Api50 + "/api/v1/File/UploadSignPic";
								DataService.post(signUrl, signatureData).then(function(res) {
									//打印工单
									$scope.print && printOrder();
									$timeout(function() {
										$scope.process.SaveState = 1;
										UtilsService.saveModal(function() {
											isSubmitting = false;
											mui.back();
										});
									}, 800);
								})
								canvas.hide();
								plus.screen.unlockOrientation(); //解除屏幕方向的锁定
								plus.screen.lockOrientation("portrait-primary");
								break;
							case "close":
								canvas.hide();
								plus.screen.unlockOrientation(); //解除屏幕方向的锁定
								plus.screen.lockOrientation("portrait-primary");
								break;
							default:
								break;
						}
					}

					var canvas = {
						show: function() {
							document.getElementById("signatureparent").style.display = "block";
							document.getElementById("header").style.display = "none";
							document.getElementById("content").style.display = "none";
							document.getElementById("footer").style.display = "none";
						},
						hide: function() {
							document.getElementById("signatureparent").style.display = "none";
							document.getElementById("header").style.display = "block";
							document.getElementById("content").style.display = "block";
							document.getElementById("footer").style.display = "block";
						}
					}

				}
			]);

			//扫描产品回调
			function scanCallback(res) {

				res = JSON.parse(res);
//				console.log(JSON.stringify(res))
				var appElement = document.querySelector('[ng-controller=DebugEditController]');
				var $scope = angular.element(appElement).scope();
				if(res.resType == 1) {
					res.resInfo.SkuName = decodeURIComponent(res.resInfo.SkuName).replace(/@squotes@/g, "'").replace(/@dquotes@/g, "\"");
					res.resInfo.ProdName = decodeURIComponent(res.resInfo.ProdName).replace(/@squotes@/g, "'").replace(/@dquotes@/g,
						"\"");
					res.resInfo.MDCode = res.codeValue;
					if(!res.InnerCode) {
						var innercodeDiv = document.getElementById("prodInnerCode");
						innercodeDiv.innerText = "";
						innercodeDiv.focus();
						innercodeDiv.blur();
					}
					$scope.ProdList = [];
					$scope.ProdList.push(res.resInfo);
					$scope.prodInfo = {
						ProdID: res.resInfo.ProdID,
						ProdName: res.resInfo.ProdName,
						SkuID: res.resInfo.SkuID,
						SkuName: res.resInfo.SkuName,
						InnerCode: decodeURIComponent(res.resInfo.InnerCode).replace(/@squotes@/g, "'").replace(/@dquotes@/g, "\""), //res.resInfo.InnerCode
						MDCode: res.resInfo.MDCode,
					};
					$scope.EqJane=res.resInfo.EqJane;
					$scope.$apply();
				} else if(res.resType == 2) {
					mui.toast("当前码为设备码，请核对后再试")
				}
			}

			//选择抄送人员回调
			function selectUserCallback(obj) {
				var appElement = document.querySelector('[ng-controller=DebugEditController]');
				var $scope = angular.element(appElement).scope();
				$scope.sendUsers = angular.copy(obj);
				$scope.$apply();
			}

			//选择调试人员回调
			function selectDenugUserCallback(obj) {
				var appElement = document.querySelector('[ng-controller=DebugEditController]');
				var $scope = angular.element(appElement).scope();
				$scope.debugUsers = angular.copy(obj);
				$scope.$apply();
			}

			//手持设备回调
			function handleCallBack(obj) {
				obj = JSON.parse(obj);
				if(obj.resType == 1) {
					obj.resInfo.MDCode = obj.codeValue;
					obj.resInfo.SkuName = decodeURIComponent(obj.resInfo.SkuName).replace(/@squotes@/g, "'").replace(/@dquotes@/g, "\"");
					obj.resInfo.ProdName = decodeURIComponent(obj.resInfo.ProdName).replace(/@squotes@/g, "'").replace(/@dquotes@/g,
						"\"");
				}
				var resInfo = obj.resInfo;
				var appElement = document.querySelector('[ng-controller=DebugEditController]');
				var $scope = angular.element(appElement).scope();
				//检测是否同一种产品
				var checkRepeat = function(mdcode) {
					return $scope.ProdList.some(function(item) {
						return item.MDCode == mdcode;
					});
				};
				if(checkRepeat(resInfo.MDCode)) {
					mui.toast("此迈迪国标通用物联码已存在于清单中");
					return;
				}
				if($scope.needCheck) {
					if($scope.ProdList.length == 0) {
						ProdID = resInfo.ProdID;
					} else if(ProdID != resInfo.ProdID) {
						mui.toast("此产品不同于其他产品类型");
						return;
					}
				}
				$scope.ProdList.push(resInfo);
				$scope.$apply();
			};

			mui.plusReady(function() {
				angular.bootstrap(document.getElementById("MdTong"), ["MdTong"]);
			});
		</script>
	</body>

</html>